name: Sync Changelog to PublicWeb

on:
  push:
    branches: [main]
    paths:
      - 'CHANGELOG.md'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-changelog:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Parse CHANGELOG and generate release notes
        run: |
          # Extract versions and content from CHANGELOG.md
          python3 << 'PYTHON_SCRIPT'
          import re
          import os

          with open('CHANGELOG.md', 'r', encoding='utf-8') as f:
              changelog = f.read()

          # Extract version sections (## [x.x.x] - date)
          version_pattern = r'## \[(\d+\.\d+\.\d+)\](?: - (\d{4}-\d{2}-\d{2}))?'
          sections = re.split(version_pattern, changelog)

          # Build version data
          versions = []
          i = 1
          while i < len(sections):
              version = sections[i]
              date = sections[i+1] if i+1 < len(sections) and sections[i+1] else ''
              content = sections[i+2] if i+2 < len(sections) else ''

              # Convert date to month/year
              if date:
                  year, month, _ = date.split('-')
                  month_names = {
                      '01': 'January', '02': 'February', '03': 'March',
                      '04': 'April', '05': 'May', '06': 'June',
                      '07': 'July', '08': 'August', '09': 'September',
                      '10': 'October', '11': 'November', '12': 'December'
                  }
                  month_names_de = {
                      '01': 'Januar', '02': 'Februar', '03': 'März',
                      '04': 'April', '05': 'Mai', '06': 'Juni',
                      '07': 'Juli', '08': 'August', '09': 'September',
                      '10': 'Oktober', '11': 'November', '12': 'Dezember'
                  }
                  date_en = f"{month_names[month]} {year}"
                  date_de = f"{month_names_de[month]} {year}"
              else:
                  date_en = ''
                  date_de = ''

              versions.append({
                  'version': version,
                  'date_en': date_en,
                  'date_de': date_de,
                  'content': content.strip()
              })
              i += 3

          # Generate English release notes
          en_content = '''---
          title: Release Notes
          description: Changes and new features in ReadyStackGo
          ---

          import { LinkCard } from '@astrojs/starlight/components';

          <LinkCard
            title="Full Changelog on GitHub"
            description="Detailed change history of all versions"
            href="https://github.com/Wiesenwischer/ReadyStackGo/blob/main/CHANGELOG.md"
          />

          '''

          for v in versions[:5]:  # Last 5 versions
              en_content += f"\n## Version {v['version']}\n\n"
              if v['date_en']:
                  en_content += f"*Released: {v['date_en']}*\n\n"

              # Simplify content for summary
              content = v['content']
              # Remove links like [text](url) -> text
              content = re.sub(r'\[([^\]]+)\]\([^)]+\)', r'\1', content)
              # Limit content length
              lines = content.split('\n')[:30]
              en_content += '\n'.join(lines)
              en_content += "\n\n---\n"

          en_content += '''
          ## Roadmap

          Planned features for future versions:

          - **v0.7** - CI/CD Integration & Webhooks
          - **v0.8** - Enhanced Stack Formats
          - **v1.0** - Production Readiness
          - **v2.0+** - Kubernetes Support
          '''

          # Generate German release notes
          de_content = '''---
          title: Release Notes
          description: Änderungen und neue Features in ReadyStackGo
          ---

          import { LinkCard } from '@astrojs/starlight/components';

          <LinkCard
            title="Vollständiges Changelog auf GitHub"
            description="Detaillierte Änderungshistorie aller Versionen"
            href="https://github.com/Wiesenwischer/ReadyStackGo/blob/main/CHANGELOG.md"
          />

          '''

          for v in versions[:5]:
              de_content += f"\n## Version {v['version']}\n\n"
              if v['date_de']:
                  de_content += f"*Veröffentlicht: {v['date_de']}*\n\n"

              content = v['content']
              content = re.sub(r'\[([^\]]+)\]\([^)]+\)', r'\1', content)
              lines = content.split('\n')[:30]
              de_content += '\n'.join(lines)
              de_content += "\n\n---\n"

          de_content += '''
          ## Roadmap

          Geplante Features für zukünftige Versionen:

          - **v0.7** - CI/CD Integration & Webhooks
          - **v0.8** - Erweiterte Stack-Formate
          - **v1.0** - Production Readiness
          - **v2.0+** - Kubernetes Support
          '''

          # Write files
          os.makedirs('src/ReadyStackGo.PublicWeb/src/content/docs/en', exist_ok=True)
          os.makedirs('src/ReadyStackGo.PublicWeb/src/content/docs/de', exist_ok=True)

          with open('src/ReadyStackGo.PublicWeb/src/content/docs/en/release-notes.mdx', 'w', encoding='utf-8') as f:
              # Remove leading whitespace from heredoc
              f.write('\n'.join(line.strip() if line.strip() else '' for line in en_content.split('\n')))

          with open('src/ReadyStackGo.PublicWeb/src/content/docs/de/release-notes.mdx', 'w', encoding='utf-8') as f:
              f.write('\n'.join(line.strip() if line.strip() else '' for line in de_content.split('\n')))

          print("Release notes generated successfully!")
          PYTHON_SCRIPT

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet src/ReadyStackGo.PublicWeb/src/content/docs/*/release-notes.mdx; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "docs: Sync release notes from CHANGELOG.md"
          title: "docs: Update PublicWeb release notes"
          body: |
            This PR updates the PublicWeb release notes from CHANGELOG.md.

            Auto-generated by the sync-changelog workflow.
          branch: docs/sync-release-notes
          base: main
          labels: documentation
