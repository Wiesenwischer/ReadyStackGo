name: Sync Wiki from Docs

on:
  push:
    branches: [main]
    paths:
      - 'docs/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-wiki:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout wiki
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}.wiki
          path: wiki
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Sync docs to wiki
        run: |
          # Clear existing wiki content (except .git)
          find wiki -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +

          # Copy docs to wiki (flatten structure for GitHub Wiki)
          # GitHub Wiki doesn't support subdirectories well, so we prefix filenames

          # Copy Home.md directly
          if [ -f "docs/Home.md" ]; then
            cp docs/Home.md wiki/Home.md
          fi

          # Copy all other markdown files with folder prefix
          find docs -name "*.md" ! -name "Home.md" ! -name ".wiki-config.md" | while read file; do
            # Get relative path from docs/
            rel_path="${file#docs/}"
            # Convert path to wiki-friendly name (Architecture/Overview.md -> Architecture-Overview.md)
            wiki_name=$(echo "$rel_path" | sed 's|/|-|g')
            cp "$file" "wiki/$wiki_name"
          done

      - name: Generate Sidebar
        run: |
          cat > wiki/_Sidebar.md << 'EOF'
          ### ReadyStackGo Wiki

          **[[Home]]**

          ---

          **Getting Started**
          - [[Overview|Getting-Started-Overview]]
          - [[Installation|Getting-Started-Installation]]
          - [[Quick Start|Getting-Started-Quick-Start]]

          **Architecture**
          - [[Overview|Architecture-Overview]]
          - [[Components|Architecture-Components]]
          - [[Container Lifecycle|Architecture-Container-Lifecycle]]
          - [[Deployment Engine|Architecture-Deployment-Engine]]

          **Configuration**
          - [[Overview|Configuration-Overview]]
          - [[Config Files|Configuration-Config-Files]]
          - [[Manifest Specification|Configuration-Manifest-Specification]]
          - [[Registries|Configuration-Registries]]
          - [[Feature Flags|Configuration-Feature-Flags]]

          **Security**
          - [[Overview|Security-Overview]]
          - [[Initial Setup|Security-Initial-Setup]]
          - [[Authentication|Security-Authentication]]
          - [[Authorization|Security-Authorization]]
          - [[TLS Configuration|Security-TLS-Configuration]]

          **Setup Wizard**
          - [[Wizard Flow|Setup-Wizard-Wizard-Flow]]

          **Development**
          - [[Setup Environment|Development-Setup-Environment]]
          - [[Git Workflow|Development-Git-Workflow]]
          - [[Coding Guidelines|Development-Coding-Guidelines]]
          - [[Testing|Development-Testing]]
          - [[Contributing|Development-Contributing]]

          **Operations**
          - [[Release Management|Operations-Release-Management]]
          - [[Updates|Operations-Updates]]
          - [[Troubleshooting|Operations-Troubleshooting]]

          **CI/CD**
          - [[Pipeline Integration|CI-CD-Pipeline-Integration]]
          - [[Workflows|CI-CD-Workflows]]

          **Reference**
          - [[Roadmap|Reference-Roadmap]]
          - [[API Reference|Reference-API-Reference]]
          - [[Configuration Reference|Reference-Configuration-Reference]]
          - [[Manifest Schema|Reference-Manifest-Schema]]
          - [[Multi-Environment|Reference-Multi-Environment]]
          - [[Stack Sources|Reference-Stack-Sources]]
          - [[Plugin System|Reference-Plugin-System]]
          - [[Technical Specification|Reference-Technical-Specification]]
          - [[Full Specification|Reference-Full-Specification]]

          **Specifications**
          - [[v0.6 SQLite Multi-User|Specifications-v0.6-sqlite-multiuser]]

          **Release Notes**
          - [[v0.4.0|Release-Notes-v0.4.0]]
          - [[v0.3.0|Release-Notes-v0.3.0]]
          EOF

      - name: Push to wiki
        working-directory: wiki
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Sync documentation from main branch"
            git push
          fi
