name: Release Drafter

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, reopened, synchronize]
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  # Job 1: Update draft and autolabel PRs
  update_release_draft:
    permissions:
      contents: write
      pull-requests: write
    runs-on: ubuntu-latest
    outputs:
      tag_name: ${{ steps.drafter.outputs.tag_name }}
      version: ${{ steps.drafter.outputs.resolved_version }}
      body: ${{ steps.drafter.outputs.body }}
      id: ${{ steps.drafter.outputs.id }}
    steps:
      - uses: release-drafter/release-drafter@v6
        id: drafter
        with:
          config-name: release-drafter.yml
          publish: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job 2: Update CHANGELOG and PublicWeb release notes in PR before merge
  update_changelog_in_pr:
    needs: update_release_draft
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    permissions:
      contents: write
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update CHANGELOG.md
        id: changelog
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Use Release Drafter's resolved version (single source of truth)
          VERSION="${{ needs.update_release_draft.outputs.version }}"
          TAG_NAME="${{ needs.update_release_draft.outputs.tag_name }}"
          TODAY=$(date +%Y-%m-%d)

          echo "Version from Release Drafter: $VERSION"
          echo "Tag: $TAG_NAME"

          # Get release body from draft, fallback to PR title if empty
          RELEASE_BODY='${{ needs.update_release_draft.outputs.body }}'

          if [ -z "$RELEASE_BODY" ] || [ "$RELEASE_BODY" = "null" ]; then
            # Use PR title and body as fallback
            PR_TITLE="${{ github.event.pull_request.title }}"
            PR_BODY=$(gh pr view ${{ github.event.pull_request.number }} --json body -q '.body')

            # Get labels for categorization
            LABELS=$(gh pr view ${{ github.event.pull_request.number }} --json labels --jq '.labels[].name' | tr '\n' ' ')

            # Determine category from labels
            if echo "$LABELS" | grep -qE "bug|fix"; then
              CATEGORY="### Bug Fixes"
            elif echo "$LABELS" | grep -qE "feature|enhancement"; then
              CATEGORY="### Added"
            elif echo "$LABELS" | grep -qE "documentation|docs"; then
              CATEGORY="### Documentation"
            else
              CATEGORY="### Changes"
            fi

            RELEASE_BODY=$(printf "%s\n- %s" "$CATEGORY" "$PR_TITLE")

            if [ -n "$PR_BODY" ] && [ "$PR_BODY" != "null" ]; then
              RELEASE_BODY=$(printf "%s\n\n%s" "$RELEASE_BODY" "$PR_BODY")
            fi
          fi

          # Check if this version already exists in CHANGELOG
          if grep -q "## \[$VERSION\]" CHANGELOG.md 2>/dev/null; then
            echo "Version $VERSION already in CHANGELOG, skipping"
            echo "updated=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Create new CHANGELOG entry
          NEW_ENTRY="## [$VERSION] - $TODAY

          $RELEASE_BODY
          "

          # Check if CHANGELOG.md exists
          if [ -f CHANGELOG.md ]; then
            FIRST_VERSION_LINE=$(grep -n "^## \[" CHANGELOG.md | head -1 | cut -d: -f1)

            if [ -n "$FIRST_VERSION_LINE" ]; then
              head -n $((FIRST_VERSION_LINE - 1)) CHANGELOG.md > CHANGELOG.tmp
              echo "" >> CHANGELOG.tmp
              echo "$NEW_ENTRY" >> CHANGELOG.tmp
              tail -n +$FIRST_VERSION_LINE CHANGELOG.md >> CHANGELOG.tmp
              mv CHANGELOG.tmp CHANGELOG.md
            else
              echo "" >> CHANGELOG.md
              echo "$NEW_ENTRY" >> CHANGELOG.md
            fi
          else
            echo "# Changelog" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "All notable changes to this project will be documented in this file." >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/)," >> CHANGELOG.md
            echo "and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html)." >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "$NEW_ENTRY" >> CHANGELOG.md
          fi

          echo "Updated CHANGELOG.md with version $VERSION"
          echo "updated=true" >> $GITHUB_OUTPUT

      - name: Generate PublicWeb release notes
        if: steps.changelog.outputs.updated == 'true'
        run: |
          python3 << 'PYTHON_SCRIPT'
          import re
          import os

          with open('CHANGELOG.md', 'r', encoding='utf-8') as f:
              changelog = f.read()

          # Extract version sections (## [x.x.x] - date)
          version_pattern = r'## \[(\d+\.\d+\.\d+)\](?: - (\d{4}-\d{2}-\d{2}))?'
          sections = re.split(version_pattern, changelog)

          # Build version data
          versions = []
          i = 1
          while i < len(sections):
              version = sections[i]
              date = sections[i+1] if i+1 < len(sections) and sections[i+1] else ''
              content = sections[i+2] if i+2 < len(sections) else ''

              # Convert date to month/year
              if date:
                  year, month, _ = date.split('-')
                  month_names = {
                      '01': 'January', '02': 'February', '03': 'March',
                      '04': 'April', '05': 'May', '06': 'June',
                      '07': 'July', '08': 'August', '09': 'September',
                      '10': 'October', '11': 'November', '12': 'December'
                  }
                  month_names_de = {
                      '01': 'Januar', '02': 'Februar', '03': 'März',
                      '04': 'April', '05': 'Mai', '06': 'Juni',
                      '07': 'Juli', '08': 'August', '09': 'September',
                      '10': 'Oktober', '11': 'November', '12': 'Dezember'
                  }
                  date_en = f"{month_names[month]} {year}"
                  date_de = f"{month_names_de[month]} {year}"
              else:
                  date_en = ''
                  date_de = ''

              versions.append({
                  'version': version,
                  'date_en': date_en,
                  'date_de': date_de,
                  'content': content.strip()
              })
              i += 3

          # Generate English release notes
          en_content = '''---
          title: Release Notes
          description: Changes and new features in ReadyStackGo
          ---

          import { LinkCard } from '@astrojs/starlight/components';

          <LinkCard
            title="Full Changelog on GitHub"
            description="Detailed change history of all versions"
            href="https://github.com/Wiesenwischer/ReadyStackGo/blob/main/CHANGELOG.md"
          />

          '''

          for v in versions[:5]:  # Last 5 versions
              en_content += f"\n## Version {v['version']}\n\n"
              if v['date_en']:
                  en_content += f"*Released: {v['date_en']}*\n\n"

              content = v['content']
              content = re.sub(r'\[([^\]]+)\]\([^)]+\)', r'\1', content)
              lines = content.split('\n')[:30]
              en_content += '\n'.join(lines)
              en_content += "\n\n---\n"

          en_content += '''
          ## Roadmap

          Planned features for future versions:

          - **v0.7** - CI/CD Integration & Webhooks
          - **v0.8** - Enhanced Stack Formats
          - **v1.0** - Production Readiness
          - **v2.0+** - Kubernetes Support
          '''

          # Generate German release notes
          de_content = '''---
          title: Release Notes
          description: Änderungen und neue Features in ReadyStackGo
          ---

          import { LinkCard } from '@astrojs/starlight/components';

          <LinkCard
            title="Vollständiges Changelog auf GitHub"
            description="Detaillierte Änderungshistorie aller Versionen"
            href="https://github.com/Wiesenwischer/ReadyStackGo/blob/main/CHANGELOG.md"
          />

          '''

          for v in versions[:5]:
              de_content += f"\n## Version {v['version']}\n\n"
              if v['date_de']:
                  de_content += f"*Veröffentlicht: {v['date_de']}*\n\n"

              content = v['content']
              content = re.sub(r'\[([^\]]+)\]\([^)]+\)', r'\1', content)
              lines = content.split('\n')[:30]
              de_content += '\n'.join(lines)
              de_content += "\n\n---\n"

          de_content += '''
          ## Roadmap

          Geplante Features für zukünftige Versionen:

          - **v0.7** - CI/CD Integration & Webhooks
          - **v0.8** - Erweiterte Stack-Formate
          - **v1.0** - Production Readiness
          - **v2.0+** - Kubernetes Support
          '''

          # Write files
          os.makedirs('src/ReadyStackGo.PublicWeb/src/content/docs/en', exist_ok=True)
          os.makedirs('src/ReadyStackGo.PublicWeb/src/content/docs/de', exist_ok=True)

          with open('src/ReadyStackGo.PublicWeb/src/content/docs/en/release-notes.mdx', 'w', encoding='utf-8') as f:
              f.write('\n'.join(line.strip() if line.strip() else '' for line in en_content.split('\n')))

          with open('src/ReadyStackGo.PublicWeb/src/content/docs/de/release-notes.mdx', 'w', encoding='utf-8') as f:
              f.write('\n'.join(line.strip() if line.strip() else '' for line in de_content.split('\n')))

          print("PublicWeb release notes generated successfully!")
          PYTHON_SCRIPT

      - name: Commit and push changes
        if: steps.changelog.outputs.updated == 'true'
        run: |
          git add CHANGELOG.md
          git add src/ReadyStackGo.PublicWeb/src/content/docs/*/release-notes.mdx
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "docs: Update CHANGELOG and release notes for ${{ needs.update_release_draft.outputs.tag_name }}"
            git push origin ${{ github.head_ref }}
            echo "Pushed updates to PR branch"
          fi

  # Job 3: On merge to main, create tag and publish release
  publish_release:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from CHANGELOG
        id: version
        run: |
          # Extract the latest version from CHANGELOG.md
          VERSION=$(grep -oP '## \[\K[0-9]+\.[0-9]+\.[0-9]+' CHANGELOG.md | head -1)
          TAG_NAME="v$VERSION"

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

          # Check if tag already exists
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "tag_exists=true" >> $GITHUB_OUTPUT
            echo "Tag $TAG_NAME already exists"
          else
            echo "tag_exists=false" >> $GITHUB_OUTPUT
            echo "Will create tag $TAG_NAME"
          fi

      - name: Configure Git
        if: steps.version.outputs.tag_exists == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create and push tag
        if: steps.version.outputs.tag_exists == 'false'
        run: |
          TAG_NAME="${{ steps.version.outputs.tag_name }}"
          git tag -a "$TAG_NAME" -m "Release $TAG_NAME"
          git push origin "$TAG_NAME"
          echo "Created and pushed tag $TAG_NAME on commit $(git rev-parse HEAD)"

      - name: Publish GitHub Release
        if: steps.version.outputs.tag_exists == 'false'
        uses: release-drafter/release-drafter@v6
        with:
          config-name: release-drafter.yml
          publish: true
          tag: ${{ steps.version.outputs.tag_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
