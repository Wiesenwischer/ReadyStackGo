# v0.14 â€“ Health Dashboard + Rollback

Specification for version 0.14: Health Dashboard UI and Deployment Rollback.

## Overview

| Feature | Scope | Priority |
|---------|-------|----------|
| Health Dashboard Page | Frontend | High |
| Health History Visualization | Frontend | Medium |
| Deployment Version History | Backend + DB | High |
| Rollback API | Backend | High |
| Rollback UI | Frontend | High |

---

## 1. Health Dashboard

### 1.1 New Page: `/health`

A dedicated Health Dashboard page with an overview of all deployments.

**Layout:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Health Dashboard                                    [Live] [Refresh] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚   Healthy    â”‚  â”‚   Degraded   â”‚  â”‚  Unhealthy   â”‚               â”‚
â”‚  â”‚     12       â”‚  â”‚      2       â”‚  â”‚      1       â”‚               â”‚
â”‚  â”‚     ğŸŸ¢       â”‚  â”‚      ğŸŸ¡      â”‚  â”‚      ğŸ”´      â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Filter: [All â–¼] [Environment â–¼]                    Search: [______] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ğŸŸ¢ my-app (Production)                        3/3 Services  â”‚    â”‚
â”‚  â”‚    Last check: 2 seconds ago          Mode: Normal          â”‚    â”‚
â”‚  â”‚    â”œâ”€â”€ api          ğŸŸ¢ Healthy    (0 restarts)              â”‚    â”‚
â”‚  â”‚    â”œâ”€â”€ database     ğŸŸ¢ Healthy    (0 restarts)              â”‚    â”‚
â”‚  â”‚    â””â”€â”€ redis        ğŸŸ¢ Healthy    (0 restarts)              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ğŸŸ¡ staging-app (Staging)                      2/3 Services  â”‚    â”‚
â”‚  â”‚    Last check: 5 seconds ago          Mode: Maintenance     â”‚    â”‚
â”‚  â”‚    â”œâ”€â”€ api          ğŸŸ¢ Healthy    (0 restarts)              â”‚    â”‚
â”‚  â”‚    â”œâ”€â”€ database     ğŸŸ¢ Healthy    (0 restarts)              â”‚    â”‚
â”‚  â”‚    â””â”€â”€ worker       ğŸ”´ Unhealthy  (5 restarts)              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Components:**
- `HealthDashboardPage.tsx` - Main page
- `HealthSummaryCards.tsx` - Summary statistics cards at the top
- `HealthStackCard.tsx` - Individual deployment with services
- `HealthServiceRow.tsx` - Service row with status

**Features:**
- Real-time updates via SignalR (already implemented)
- Filter by status (Healthy/Degraded/Unhealthy)
- Filter by environment
- Text search by stack name
- Click on stack â†’ Navigate to DeploymentDetail

### 1.2 Health History Chart

Extension of the DeploymentDetail page with Health History Visualization.

**Layout:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Health History (Last 24 Hours)                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  100% â”¤ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ             â”‚
â”‚   75% â”¤                                 â–ˆâ–ˆ                           â”‚
â”‚   50% â”¤                                                              â”‚
â”‚   25% â”¤                                                              â”‚
â”‚    0% â”¤                                                              â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚        00:00    06:00    12:00    18:00    Now                       â”‚
â”‚                                                                      â”‚
â”‚  Legend: [ğŸŸ¢ Healthy] [ğŸŸ¡ Degraded] [ğŸ”´ Unhealthy]                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**API (already available):**
```
GET /api/health/deployments/{deploymentId}/history?limit=50
```

**New Components:**
- `HealthHistoryChart.tsx` - Timeline chart with health status
- Use a lightweight chart library (e.g., Recharts)

---

## 2. Deployment Rollback

### 2.1 Design Decision: Rollback Only Before Container Start

**Important:** Rollback is only available if the upgrade **failed before** container start.

**Terminology:**
| Term | Meaning | Supported |
|------|---------|-----------|
| **Rollback** | Recovery after failed upgrade (before container start) | Yes |
| **Downgrade** | Deliberate choice of an older version for a running system | No (v1) |

**Rationale:**
- Clear semantics: Rollback = Recovery on error in early upgrade phases
- Safe "Point of No Return": Once containers have been started, rollback is no longer possible
- Avoids complex logic for migration containers and DB changes
- If container start was successful â†’ new containers are already active, rollback would create inconsistent state

**Upgrade Phases and Rollback:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Upgrade v1.0 â†’ v2.0                                             â”‚
â”‚                                                                 â”‚
â”‚ 1. [ ] Validate new version               â”€â”                    â”‚
â”‚ 2. [ ] Create Snapshot                     â”‚  Rollback possible â”‚
â”‚ 3. [ ] Stop old containers                 â”‚  on error          â”‚
â”‚ 4. [ ] Pull new images                    â”€â”˜                    â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ 5. [ ] Start Container                    â† POINT OF NO RETURN  â”‚
â”‚ 6. [ ] Health Check                                             â”‚
â”‚                                                                 â”‚
â”‚ From step 5: No rollback possible                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**When Rollback is Available:**
- Upgrade failed in phase 1-4 (Validation, Snapshot, Stop, Pull)
- Error types: Version invalid, image not available, registry not reachable

**When Rollback is NOT Available:**
- Initial deployment (no snapshot)
- Containers have already been started (phase 5+)
- Upgrade was successful

### 2.2 Domain Model Extensions

**New Value Object: `DeploymentSnapshot`**

Stores the state of a deployment at a specific point in time.

```csharp
// Domain/Deployment/Deployments/DeploymentSnapshot.cs
public record DeploymentSnapshot
{
    public DeploymentSnapshotId Id { get; init; }
    public DeploymentId DeploymentId { get; init; }
    public string StackVersion { get; init; }
    public IReadOnlyDictionary<string, string> Variables { get; init; }
    public IReadOnlyCollection<ServiceSnapshot> Services { get; init; }
    public DateTime CreatedAt { get; init; }
    public string? Description { get; init; }  // "Before upgrade to v2.0"
}

public record ServiceSnapshot
{
    public string Name { get; init; }
    public string Image { get; init; }  // e.g., "myapp/api:1.5.0"
}
```

**Extension of Deployment Aggregate:**

```csharp
public class Deployment : AggregateRoot<DeploymentId>
{
    // Existing properties...

    // Snapshot is only held during upgrade
    public DeploymentSnapshot? PendingUpgradeSnapshot { get; private set; }

    // Create snapshot before upgrade
    public DeploymentSnapshot? CreateSnapshot(string? description = null)
    {
        PendingUpgradeSnapshot = new DeploymentSnapshot
        {
            Id = DeploymentSnapshotId.New(),
            DeploymentId = Id,
            StackVersion = StackVersion,
            Variables = new Dictionary<string, string>(Variables),
            Services = Services.Select(s => new ServiceSnapshot
            {
                Name = s.ServiceName,
                Image = s.Image
            }).ToList(),
            CreatedAt = SystemClock.UtcNow,
            Description = description
        };

        return PendingUpgradeSnapshot;
    }

    // Clear snapshot after successful upgrade or when containers started
    public void ClearSnapshot()
    {
        PendingUpgradeSnapshot = null;
    }

    // Rollback to previous version (only if upgrade failed before container start)
    public void RollbackToPrevious()
    {
        SelfAssertState(PendingUpgradeSnapshot != null,
            "No snapshot available for rollback.");
        SelfAssertState(Status == DeploymentStatus.Failed,
            "Rollback only available after failed upgrade (before container start)");

        // Restore from snapshot
        var targetVersion = PendingUpgradeSnapshot.StackVersion;
        StackVersion = targetVersion;
        _variables.Clear();
        foreach (var (key, value) in PendingUpgradeSnapshot.Variables)
            _variables[key] = value;

        // Clear snapshot (consumed)
        var snapshotId = PendingUpgradeSnapshot.Id;
        PendingUpgradeSnapshot = null;

        AddDomainEvent(new DeploymentRolledBack(Id, snapshotId, targetVersion));
    }

    public bool CanRollback()
    {
        return PendingUpgradeSnapshot != null &&
               Status == DeploymentStatus.Failed;  // Only if upgrade failed before container start
    }
}
```

**New Domain Event:**

```csharp
// Domain/Deployment/Events/DeploymentRolledBack.cs
public record DeploymentRolledBack(
    DeploymentId DeploymentId,
    DeploymentSnapshotId SnapshotId,
    string RestoredVersion) : IDomainEvent;
```

### 2.3 Application Layer

**New Use Case: RollbackDeployment**

```csharp
// Application/UseCases/Deployments/RollbackDeployment/RollbackDeploymentRequest.cs
// Simplified: No SnapshotId needed - Rollback always to previous version
public record RollbackDeploymentRequest(
    Guid EnvironmentId,
    Guid DeploymentId) : IRequest<RollbackDeploymentResponse>;

public record RollbackDeploymentResponse
{
    public bool Success { get; init; }
    public string? Message { get; init; }
    public Guid DeploymentId { get; init; }
    public string? PreviousVersion { get; init; }
    public string? RestoredVersion { get; init; }
}
```

```csharp
// Application/UseCases/Deployments/RollbackDeployment/RollbackDeploymentHandler.cs
public class RollbackDeploymentHandler : IRequestHandler<RollbackDeploymentRequest, RollbackDeploymentResponse>
{
    public async Task<RollbackDeploymentResponse> Handle(
        RollbackDeploymentRequest request,
        CancellationToken ct)
    {
        var deployment = await _deploymentRepository.GetByIdAsync(
            new DeploymentId(request.DeploymentId), ct);

        if (deployment == null)
            return new RollbackDeploymentResponse { Success = false, Message = "Deployment not found" };

        // Rollback only on failed upgrade (before container start)
        if (deployment.Status != DeploymentStatus.Failed)
            return new RollbackDeploymentResponse
            {
                Success = false,
                Message = "Rollback only available after failed upgrade (before container start)"
            };

        if (!deployment.CanRollback())
            return new RollbackDeploymentResponse
            {
                Success = false,
                Message = "No snapshot available for rollback"
            };

        var previousVersion = deployment.StackVersion;
        var targetVersion = deployment.PendingUpgradeSnapshot!.StackVersion;

        // Initiate rollback (consumes the snapshot)
        deployment.RollbackToPrevious();

        await _deploymentRepository.UpdateAsync(deployment, ct);

        // Trigger re-deployment
        await _mediator.Send(new RedeployRequest(
            request.EnvironmentId,
            request.DeploymentId), ct);

        return new RollbackDeploymentResponse
        {
            Success = true,
            Message = $"Rolled back from {previousVersion} to {targetVersion}",
            DeploymentId = request.DeploymentId,
            PreviousVersion = previousVersion,
            RestoredVersion = targetVersion
        };
    }
}
```

**New Use Case: GetRollbackInfo**

```csharp
// Application/UseCases/Deployments/GetRollbackInfo/GetRollbackInfoQuery.cs
public record GetRollbackInfoQuery(
    Guid EnvironmentId,
    Guid DeploymentId) : IRequest<GetRollbackInfoResponse>;

public record GetRollbackInfoResponse
{
    public bool Success { get; init; }
    public string? Message { get; init; }
    public bool CanRollback { get; init; }
    public string? CurrentVersion { get; init; }
    public string? PreviousVersion { get; init; }
    public DateTime? SnapshotCreatedAt { get; init; }
    public string? SnapshotDescription { get; init; }
}
```

### 2.4 API Endpoints

**New Endpoints:**

```http
# Get rollback information
GET /api/environments/{environmentId}/deployments/{deploymentId}/rollback

Response (Deployment running successfully):
{
  "success": true,
  "canRollback": false,
  "currentVersion": "2.0.0",
  "previousVersion": null,
  "message": "Rollback only available after failed upgrade (before container start)"
}

Response (Upgrade failed before container start - Rollback available):
{
  "success": true,
  "canRollback": true,
  "currentVersion": "2.0.0",
  "previousVersion": "1.5.0",
  "snapshotCreatedAt": "2025-12-14T10:00:00Z",
  "snapshotDescription": "Before upgrade to 2.0.0"
}

Response (Upgrade failed after container start - no Rollback):
{
  "success": true,
  "canRollback": false,
  "currentVersion": "2.0.0",
  "previousVersion": null,
  "message": "Rollback not available - containers were already started"
}
```

```http
# Rollback after failed upgrade (manually triggered)
POST /api/environments/{environmentId}/deployments/{deploymentId}/rollback

Response (Success):
{
  "success": true,
  "message": "Rolled back from 2.0.0 to 1.5.0",
  "deploymentId": "def-456",
  "previousVersion": "2.0.0",
  "restoredVersion": "1.5.0"
}

Response (Error - Deployment running):
{
  "success": false,
  "message": "Rollback only available after failed upgrade (before container start)"
}

Response (Error - no Snapshot):
{
  "success": false,
  "message": "No snapshot available for rollback"
}
```

### 2.5 Database Schema

**New Table: DeploymentSnapshots**

```sql
CREATE TABLE DeploymentSnapshots (
    Id TEXT PRIMARY KEY,
    DeploymentId TEXT NOT NULL,
    StackVersion TEXT NOT NULL,
    Variables TEXT NOT NULL,      -- JSON
    Services TEXT NOT NULL,       -- JSON
    CreatedAt TEXT NOT NULL,
    Description TEXT,
    FOREIGN KEY (DeploymentId) REFERENCES Deployments(Id)
);

CREATE INDEX IX_DeploymentSnapshots_DeploymentId ON DeploymentSnapshots(DeploymentId);
```

**EF Core Configuration:**

```csharp
// Infrastructure.DataAccess/Configurations/DeploymentSnapshotConfiguration.cs
public class DeploymentSnapshotConfiguration : IEntityTypeConfiguration<DeploymentSnapshot>
{
    public void Configure(EntityTypeBuilder<DeploymentSnapshot> builder)
    {
        builder.ToTable("DeploymentSnapshots");

        builder.HasKey(x => x.Id);
        builder.Property(x => x.Id)
            .HasConversion(
                id => id.Value.ToString(),
                str => new DeploymentSnapshotId(Guid.Parse(str)));

        builder.Property(x => x.Variables)
            .HasConversion(
                v => JsonSerializer.Serialize(v, JsonOptions),
                str => JsonSerializer.Deserialize<Dictionary<string, string>>(str, JsonOptions)!);

        builder.Property(x => x.Services)
            .HasConversion(
                s => JsonSerializer.Serialize(s, JsonOptions),
                str => JsonSerializer.Deserialize<List<ServiceSnapshot>>(str, JsonOptions)!);
    }
}
```

### 2.6 Frontend UI

**Extension of DeploymentDetail Page:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ my-app v2.0.0                              [Rollback â–¼] [Redeploy]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚ Version History                                                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â— v2.0.0 (current)              Dec 15, 2025 14:30              â”‚ â”‚
â”‚ â”‚   Upgrade to latest version                                     â”‚ â”‚
â”‚ â”‚                                                                 â”‚ â”‚
â”‚ â”‚ â—‹ v1.5.0                        Dec 10, 2025 09:15   [Rollback] â”‚ â”‚
â”‚ â”‚   Stable release                                                â”‚ â”‚
â”‚ â”‚                                                                 â”‚ â”‚
â”‚ â”‚ â—‹ v1.4.2                        Dec 01, 2025 11:00   [Rollback] â”‚ â”‚
â”‚ â”‚   Hotfix for login issue                                        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Rollback Confirmation Dialog:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Rollback Confirmation                                          [X]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  âš ï¸  You are about to rollback to version 1.5.0                     â”‚
â”‚                                                                      â”‚
â”‚  Current Version: v2.0.0                                            â”‚
â”‚  Target Version:  v1.5.0                                            â”‚
â”‚                                                                      â”‚
â”‚  Changes:                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Service     Current          Target                         â”‚    â”‚
â”‚  â”‚ api         myapp/api:2.0.0  myapp/api:1.5.0               â”‚    â”‚
â”‚  â”‚ worker      myapp/worker:2.0 myapp/worker:1.5              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                      â”‚
â”‚  This will:                                                         â”‚
â”‚  â€¢ Stop current containers                                          â”‚
â”‚  â€¢ Pull previous images (if not cached)                             â”‚
â”‚  â€¢ Start containers with previous configuration                     â”‚
â”‚                                                                      â”‚
â”‚                               [Cancel]  [Confirm Rollback]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**New Components:**
- `VersionHistorySection.tsx` - List of snapshots
- `RollbackDialog.tsx` - Confirmation dialog
- `VersionComparisonTable.tsx` - Comparison Current vs Target

**API Client Extension:**

```typescript
// api/deployments.ts

export async function getDeploymentSnapshots(
  environmentId: string,
  deploymentId: string
): Promise<DeploymentSnapshotsResponse> {
  return client.get(`/environments/${environmentId}/deployments/${deploymentId}/snapshots`);
}

export async function rollbackDeployment(
  environmentId: string,
  deploymentId: string,
  snapshotId: string
): Promise<RollbackResponse> {
  return client.post(`/environments/${environmentId}/deployments/${deploymentId}/rollback`, {
    snapshotId
  });
}
```

---

## 3. Automatic Snapshot Creation

### When are Snapshots Created?

1. **Before every deployment** - Automatically in `DeployStackHandler`
2. **Manually** - Via new API endpoint (optional for v0.14)

**Integration in DeployStackHandler:**

```csharp
// Application/UseCases/Deployments/DeployStack/DeployStackHandler.cs
public async Task<DeployStackResponse> Handle(DeployStackRequest request, CancellationToken ct)
{
    // ... existing code ...

    // If deployment already exists: Create snapshot
    var existingDeployment = await _deploymentRepository.GetByStackNameAsync(
        environmentId, stackName, ct);

    if (existingDeployment != null && existingDeployment.Status == DeploymentStatus.Running)
    {
        existingDeployment.CreateSnapshot($"Before upgrade to {newVersion}");
        await _deploymentRepository.UpdateAsync(existingDeployment, ct);
    }

    // ... continue with deployment ...
}
```

---

## 4. Implementation Order

### Phase 1: Health Dashboard (Frontend)
1. Create `HealthDashboardPage.tsx`
2. Implement `HealthSummaryCards.tsx`
3. `HealthStackCard.tsx` + `HealthServiceRow.tsx`
4. Add route `/health`
5. Add navigation link

### Phase 2: Health History Chart
1. Add chart library (Recharts)
2. Implement `HealthHistoryChart.tsx`
3. Integrate into DeploymentDetail page

### Phase 3: Rollback Backend
1. Create `DeploymentSnapshot` value object
2. Implement `DeploymentSnapshotId`
3. Extend Deployment Aggregate
4. EF Core Configuration + Migration
5. Implement `GetDeploymentSnapshotsHandler`
6. Implement `RollbackDeploymentHandler`
7. Add API endpoints

### Phase 4: Rollback Frontend
1. Extend API client
2. Implement `VersionHistorySection.tsx`
3. Implement `RollbackDialog.tsx`
4. Integrate into DeploymentDetail page

### Phase 5: Automatic Snapshots
1. Extend DeployStackHandler
2. Implement snapshot limit (max 10)

---

## 5. Tests

### Unit Tests
- `DeploymentSnapshotTests.cs` - Snapshot Creation, Limit enforcement
- `DeploymentRollbackTests.cs` - Rollback state transitions
- `GetDeploymentSnapshotsHandlerTests.cs`
- `RollbackDeploymentHandlerTests.cs`

### Integration Tests
- Snapshot persistence in SQLite
- Rollback E2E with Docker TestContainers
- API endpoint tests

### Frontend Tests
- HealthDashboard rendering
- Rollback dialog flow
- Version comparison

---

## 6. Out of Scope for v0.14

The following features are deferred to later versions:

- **Health Alerts/Notifications** â†’ v0.17 (Metrics & Audit)
- **Prometheus/Grafana Integration** â†’ v0.17
- **Partial Rollback** (only individual services) â†’ Post v1.0
- **Blue/Green Deployments** â†’ Post v1.0
- **Canary Deployments** â†’ Post v1.0
- **Rollback Approval Workflow** â†’ Post v1.0

---

## 7. Dependencies

### New NPM Packages (Frontend)
```json
{
  "recharts": "^2.15.0"  // For Health History Chart
}
```

### No New NuGet Packages Required

The backend already uses:
- MediatR for CQRS
- EF Core for Persistence
- System.Text.Json for Serialization
