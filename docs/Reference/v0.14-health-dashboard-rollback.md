# v0.14 â€“ Health Dashboard + Rollback

Spezifikation fÃ¼r Version 0.14: Health Dashboard UI und Deployment Rollback.

## Ãœbersicht

| Feature | Scope | PrioritÃ¤t |
|---------|-------|-----------|
| Health Dashboard Page | Frontend | Hoch |
| Health History Visualization | Frontend | Mittel |
| Deployment Version History | Backend + DB | Hoch |
| Rollback API | Backend | Hoch |
| Rollback UI | Frontend | Hoch |

---

## 1. Health Dashboard

### 1.1 Neue Page: `/health`

Eine dedizierte Health Dashboard Page mit GesamtÃ¼bersicht aller Deployments.

**Layout:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Health Dashboard                                    [Live] [Refresh] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚   Healthy    â”‚  â”‚   Degraded   â”‚  â”‚  Unhealthy   â”‚               â”‚
â”‚  â”‚     12       â”‚  â”‚      2       â”‚  â”‚      1       â”‚               â”‚
â”‚  â”‚     ğŸŸ¢       â”‚  â”‚      ğŸŸ¡      â”‚  â”‚      ğŸ”´      â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Filter: [All â–¼] [Environment â–¼]                    Search: [______] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ğŸŸ¢ my-app (Production)                        3/3 Services  â”‚    â”‚
â”‚  â”‚    Last check: 2 seconds ago          Mode: Normal          â”‚    â”‚
â”‚  â”‚    â”œâ”€â”€ api          ğŸŸ¢ Healthy    (0 restarts)              â”‚    â”‚
â”‚  â”‚    â”œâ”€â”€ database     ğŸŸ¢ Healthy    (0 restarts)              â”‚    â”‚
â”‚  â”‚    â””â”€â”€ redis        ğŸŸ¢ Healthy    (0 restarts)              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ğŸŸ¡ staging-app (Staging)                      2/3 Services  â”‚    â”‚
â”‚  â”‚    Last check: 5 seconds ago          Mode: Maintenance     â”‚    â”‚
â”‚  â”‚    â”œâ”€â”€ api          ğŸŸ¢ Healthy    (0 restarts)              â”‚    â”‚
â”‚  â”‚    â”œâ”€â”€ database     ğŸŸ¢ Healthy    (0 restarts)              â”‚    â”‚
â”‚  â”‚    â””â”€â”€ worker       ğŸ”´ Unhealthy  (5 restarts)              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Komponenten:**
- `HealthDashboardPage.tsx` - Hauptseite
- `HealthSummaryCards.tsx` - Statistik-Karten oben
- `HealthStackCard.tsx` - Einzelnes Deployment mit Services
- `HealthServiceRow.tsx` - Service-Zeile mit Status

**Features:**
- Real-time Updates via SignalR (bereits implementiert)
- Filter nach Status (Healthy/Degraded/Unhealthy)
- Filter nach Environment
- Textsuche nach Stack-Name
- Klick auf Stack â†’ Navigation zu DeploymentDetail

### 1.2 Health History Chart

Erweiterung der DeploymentDetail Page um Health History Visualization.

**Layout:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Health History (Last 24 Hours)                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  100% â”¤ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ             â”‚
â”‚   75% â”¤                                 â–ˆâ–ˆ                           â”‚
â”‚   50% â”¤                                                              â”‚
â”‚   25% â”¤                                                              â”‚
â”‚    0% â”¤                                                              â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚        00:00    06:00    12:00    18:00    Now                       â”‚
â”‚                                                                      â”‚
â”‚  Legend: [ğŸŸ¢ Healthy] [ğŸŸ¡ Degraded] [ğŸ”´ Unhealthy]                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**API (bereits vorhanden):**
```
GET /api/health/deployments/{deploymentId}/history?limit=50
```

**Neue Komponenten:**
- `HealthHistoryChart.tsx` - Timeline-Chart mit Health-Status
- Verwendung einer leichtgewichtigen Chart-Library (z.B. Recharts)

---

## 2. Deployment Rollback

### 2.1 Design-Entscheidung: Rollback nur vor Container-Start

**Wichtig:** Rollback ist nur verfÃ¼gbar wenn das Upgrade **vor** dem Container-Start fehlgeschlagen ist.

**BegriffsklÃ¤rung:**
| Begriff | Bedeutung | UnterstÃ¼tzt |
|---------|-----------|-------------|
| **Rollback** | Recovery nach fehlgeschlagenem Upgrade (vor Container-Start) | Ja |
| **Downgrade** | Bewusste Wahl einer Ã¤lteren Version fÃ¼r laufendes System | Nein (v1) |

**BegrÃ¼ndung:**
- Klare Semantik: Rollback = Recovery bei Fehler in frÃ¼hen Upgrade-Phasen
- Sicherer "Point of No Return": Sobald Container gestartet wurden, ist Rollback nicht mehr mÃ¶glich
- Vermeidet komplexe Logik fÃ¼r Migration-Container und DB-Ã„nderungen
- Wenn Container-Start erfolgreich war â†’ neue Container sind bereits aktiv, Rollback wÃ¼rde inkonsistenten Zustand erzeugen

**Upgrade-Phasen und Rollback:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Upgrade v1.0 â†’ v2.0                                             â”‚
â”‚                                                                 â”‚
â”‚ 1. [ ] Validate neue Version            â”€â”                      â”‚
â”‚ 2. [ ] Create Snapshot                   â”‚  Rollback mÃ¶glich    â”‚
â”‚ 3. [ ] Stop alte Container               â”‚  bei Fehler          â”‚
â”‚ 4. [ ] Pull neue Images                 â”€â”˜                      â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ 5. [ ] Start Container                  â† POINT OF NO RETURN    â”‚
â”‚ 6. [ ] Health Check                                             â”‚
â”‚                                                                 â”‚
â”‚ Ab Schritt 5: Kein Rollback mehr mÃ¶glich                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Wann Rollback verfÃ¼gbar:**
- Upgrade ist in Phase 1-4 fehlgeschlagen (Validation, Snapshot, Stop, Pull)
- Fehlertypen: Version ungÃ¼ltig, Image nicht verfÃ¼gbar, Registry nicht erreichbar

**Wann Rollback NICHT verfÃ¼gbar:**
- Initial-Deployment (kein Snapshot)
- Container wurden bereits gestartet (Phase 5+)
- Upgrade war erfolgreich

### 2.2 Domain Model Erweiterungen

**Neues Value Object: `DeploymentSnapshot`**

Speichert den Zustand eines Deployments zu einem bestimmten Zeitpunkt.

```csharp
// Domain/Deployment/Deployments/DeploymentSnapshot.cs
public record DeploymentSnapshot
{
    public DeploymentSnapshotId Id { get; init; }
    public DeploymentId DeploymentId { get; init; }
    public string StackVersion { get; init; }
    public IReadOnlyDictionary<string, string> Variables { get; init; }
    public IReadOnlyCollection<ServiceSnapshot> Services { get; init; }
    public DateTime CreatedAt { get; init; }
    public string? Description { get; init; }  // "Before upgrade to v2.0"
}

public record ServiceSnapshot
{
    public string Name { get; init; }
    public string Image { get; init; }  // z.B. "myapp/api:1.5.0"
}
```

**Erweiterung Deployment Aggregate:**

```csharp
public class Deployment : AggregateRoot<DeploymentId>
{
    // Existing properties...

    // Snapshot wird nur wÃ¤hrend Upgrade gehalten
    public DeploymentSnapshot? PendingUpgradeSnapshot { get; private set; }

    // Snapshot vor Upgrade erstellen
    public DeploymentSnapshot? CreateSnapshot(string? description = null)
    {
        PendingUpgradeSnapshot = new DeploymentSnapshot
        {
            Id = DeploymentSnapshotId.New(),
            DeploymentId = Id,
            StackVersion = StackVersion,
            Variables = new Dictionary<string, string>(Variables),
            Services = Services.Select(s => new ServiceSnapshot
            {
                Name = s.ServiceName,
                Image = s.Image
            }).ToList(),
            CreatedAt = SystemClock.UtcNow,
            Description = description
        };

        return PendingUpgradeSnapshot;
    }

    // Snapshot lÃ¶schen nach erfolgreichem Upgrade oder wenn Container gestartet
    public void ClearSnapshot()
    {
        PendingUpgradeSnapshot = null;
    }

    // Rollback zur vorherigen Version (nur wenn Upgrade vor Container-Start fehlschlug)
    public void RollbackToPrevious()
    {
        SelfAssertState(PendingUpgradeSnapshot != null,
            "No snapshot available for rollback.");
        SelfAssertState(Status == DeploymentStatus.Failed,
            "Rollback only available after failed upgrade (before container start)");

        // Restore from snapshot
        var targetVersion = PendingUpgradeSnapshot.StackVersion;
        StackVersion = targetVersion;
        _variables.Clear();
        foreach (var (key, value) in PendingUpgradeSnapshot.Variables)
            _variables[key] = value;

        // Clear snapshot (consumed)
        var snapshotId = PendingUpgradeSnapshot.Id;
        PendingUpgradeSnapshot = null;

        AddDomainEvent(new DeploymentRolledBack(Id, snapshotId, targetVersion));
    }

    public bool CanRollback()
    {
        return PendingUpgradeSnapshot != null &&
               Status == DeploymentStatus.Failed;  // Nur wenn Upgrade vor Container-Start fehlschlug
    }
}
```

**Neues Domain Event:**

```csharp
// Domain/Deployment/Events/DeploymentRolledBack.cs
public record DeploymentRolledBack(
    DeploymentId DeploymentId,
    DeploymentSnapshotId SnapshotId,
    string RestoredVersion) : IDomainEvent;
```

### 2.3 Application Layer

**Neuer Use Case: RollbackDeployment**

```csharp
// Application/UseCases/Deployments/RollbackDeployment/RollbackDeploymentRequest.cs
// Vereinfacht: Keine SnapshotId nÃ¶tig - Rollback immer zur vorherigen Version
public record RollbackDeploymentRequest(
    Guid EnvironmentId,
    Guid DeploymentId) : IRequest<RollbackDeploymentResponse>;

public record RollbackDeploymentResponse
{
    public bool Success { get; init; }
    public string? Message { get; init; }
    public Guid DeploymentId { get; init; }
    public string? PreviousVersion { get; init; }
    public string? RestoredVersion { get; init; }
}
```

```csharp
// Application/UseCases/Deployments/RollbackDeployment/RollbackDeploymentHandler.cs
public class RollbackDeploymentHandler : IRequestHandler<RollbackDeploymentRequest, RollbackDeploymentResponse>
{
    public async Task<RollbackDeploymentResponse> Handle(
        RollbackDeploymentRequest request,
        CancellationToken ct)
    {
        var deployment = await _deploymentRepository.GetByIdAsync(
            new DeploymentId(request.DeploymentId), ct);

        if (deployment == null)
            return new RollbackDeploymentResponse { Success = false, Message = "Deployment not found" };

        // Rollback nur bei fehlgeschlagenem Upgrade (vor Container-Start)
        if (deployment.Status != DeploymentStatus.Failed)
            return new RollbackDeploymentResponse
            {
                Success = false,
                Message = "Rollback only available after failed upgrade (before container start)"
            };

        if (!deployment.CanRollback())
            return new RollbackDeploymentResponse
            {
                Success = false,
                Message = "No snapshot available for rollback"
            };

        var previousVersion = deployment.StackVersion;
        var targetVersion = deployment.PendingUpgradeSnapshot!.StackVersion;

        // Rollback initiieren (konsumiert den Snapshot)
        deployment.RollbackToPrevious();

        await _deploymentRepository.UpdateAsync(deployment, ct);

        // Re-Deployment triggern
        await _mediator.Send(new RedeployRequest(
            request.EnvironmentId,
            request.DeploymentId), ct);

        return new RollbackDeploymentResponse
        {
            Success = true,
            Message = $"Rolled back from {previousVersion} to {targetVersion}",
            DeploymentId = request.DeploymentId,
            PreviousVersion = previousVersion,
            RestoredVersion = targetVersion
        };
    }
}
```

**Neuer Use Case: GetRollbackInfo**

```csharp
// Application/UseCases/Deployments/GetRollbackInfo/GetRollbackInfoQuery.cs
public record GetRollbackInfoQuery(
    Guid EnvironmentId,
    Guid DeploymentId) : IRequest<GetRollbackInfoResponse>;

public record GetRollbackInfoResponse
{
    public bool Success { get; init; }
    public string? Message { get; init; }
    public bool CanRollback { get; init; }
    public string? CurrentVersion { get; init; }
    public string? PreviousVersion { get; init; }
    public DateTime? SnapshotCreatedAt { get; init; }
    public string? SnapshotDescription { get; init; }
}
```

### 2.4 API Endpoints

**Neue Endpoints:**

```http
# Rollback-Informationen abrufen
GET /api/environments/{environmentId}/deployments/{deploymentId}/rollback

Response (Deployment lÃ¤uft erfolgreich):
{
  "success": true,
  "canRollback": false,
  "currentVersion": "2.0.0",
  "previousVersion": null,
  "message": "Rollback only available after failed upgrade (before container start)"
}

Response (Upgrade fehlgeschlagen vor Container-Start - Rollback verfÃ¼gbar):
{
  "success": true,
  "canRollback": true,
  "currentVersion": "2.0.0",
  "previousVersion": "1.5.0",
  "snapshotCreatedAt": "2025-12-14T10:00:00Z",
  "snapshotDescription": "Before upgrade to 2.0.0"
}

Response (Upgrade fehlgeschlagen nach Container-Start - kein Rollback):
{
  "success": true,
  "canRollback": false,
  "currentVersion": "2.0.0",
  "previousVersion": null,
  "message": "Rollback not available - containers were already started"
}
```

```http
# Rollback nach fehlgeschlagenem Upgrade (manuell getriggert)
POST /api/environments/{environmentId}/deployments/{deploymentId}/rollback

Response (Erfolg):
{
  "success": true,
  "message": "Rolled back from 2.0.0 to 1.5.0",
  "deploymentId": "def-456",
  "previousVersion": "2.0.0",
  "restoredVersion": "1.5.0"
}

Response (Fehler - Deployment lÃ¤uft):
{
  "success": false,
  "message": "Rollback only available after failed upgrade (before container start)"
}

Response (Fehler - kein Snapshot):
{
  "success": false,
  "message": "No snapshot available for rollback"
}
```

### 2.4 Database Schema

**Neue Tabelle: DeploymentSnapshots**

```sql
CREATE TABLE DeploymentSnapshots (
    Id TEXT PRIMARY KEY,
    DeploymentId TEXT NOT NULL,
    StackVersion TEXT NOT NULL,
    Variables TEXT NOT NULL,      -- JSON
    Services TEXT NOT NULL,       -- JSON
    CreatedAt TEXT NOT NULL,
    Description TEXT,
    FOREIGN KEY (DeploymentId) REFERENCES Deployments(Id)
);

CREATE INDEX IX_DeploymentSnapshots_DeploymentId ON DeploymentSnapshots(DeploymentId);
```

**EF Core Configuration:**

```csharp
// Infrastructure.DataAccess/Configurations/DeploymentSnapshotConfiguration.cs
public class DeploymentSnapshotConfiguration : IEntityTypeConfiguration<DeploymentSnapshot>
{
    public void Configure(EntityTypeBuilder<DeploymentSnapshot> builder)
    {
        builder.ToTable("DeploymentSnapshots");

        builder.HasKey(x => x.Id);
        builder.Property(x => x.Id)
            .HasConversion(
                id => id.Value.ToString(),
                str => new DeploymentSnapshotId(Guid.Parse(str)));

        builder.Property(x => x.Variables)
            .HasConversion(
                v => JsonSerializer.Serialize(v, JsonOptions),
                str => JsonSerializer.Deserialize<Dictionary<string, string>>(str, JsonOptions)!);

        builder.Property(x => x.Services)
            .HasConversion(
                s => JsonSerializer.Serialize(s, JsonOptions),
                str => JsonSerializer.Deserialize<List<ServiceSnapshot>>(str, JsonOptions)!);
    }
}
```

### 2.5 Frontend UI

**Erweiterung DeploymentDetail Page:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ my-app v2.0.0                              [Rollback â–¼] [Redeploy]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚ Version History                                                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â— v2.0.0 (current)              Dec 15, 2025 14:30              â”‚ â”‚
â”‚ â”‚   Upgrade to latest version                                     â”‚ â”‚
â”‚ â”‚                                                                 â”‚ â”‚
â”‚ â”‚ â—‹ v1.5.0                        Dec 10, 2025 09:15   [Rollback] â”‚ â”‚
â”‚ â”‚   Stable release                                                â”‚ â”‚
â”‚ â”‚                                                                 â”‚ â”‚
â”‚ â”‚ â—‹ v1.4.2                        Dec 01, 2025 11:00   [Rollback] â”‚ â”‚
â”‚ â”‚   Hotfix for login issue                                        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Rollback Confirmation Dialog:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Rollback Confirmation                                          [X]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  âš ï¸  You are about to rollback to version 1.5.0                     â”‚
â”‚                                                                      â”‚
â”‚  Current Version: v2.0.0                                            â”‚
â”‚  Target Version:  v1.5.0                                            â”‚
â”‚                                                                      â”‚
â”‚  Changes:                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Service     Current          Target                         â”‚    â”‚
â”‚  â”‚ api         myapp/api:2.0.0  myapp/api:1.5.0               â”‚    â”‚
â”‚  â”‚ worker      myapp/worker:2.0 myapp/worker:1.5              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                      â”‚
â”‚  This will:                                                         â”‚
â”‚  â€¢ Stop current containers                                          â”‚
â”‚  â€¢ Pull previous images (if not cached)                             â”‚
â”‚  â€¢ Start containers with previous configuration                     â”‚
â”‚                                                                      â”‚
â”‚                               [Cancel]  [Confirm Rollback]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Neue Komponenten:**
- `VersionHistorySection.tsx` - Liste der Snapshots
- `RollbackDialog.tsx` - BestÃ¤tigungs-Dialog
- `VersionComparisonTable.tsx` - Vergleich Current vs Target

**API Client Erweiterung:**

```typescript
// api/deployments.ts

export async function getDeploymentSnapshots(
  environmentId: string,
  deploymentId: string
): Promise<DeploymentSnapshotsResponse> {
  return client.get(`/environments/${environmentId}/deployments/${deploymentId}/snapshots`);
}

export async function rollbackDeployment(
  environmentId: string,
  deploymentId: string,
  snapshotId: string
): Promise<RollbackResponse> {
  return client.post(`/environments/${environmentId}/deployments/${deploymentId}/rollback`, {
    snapshotId
  });
}
```

---

## 3. Automatische Snapshot-Erstellung

### Wann werden Snapshots erstellt?

1. **Vor jedem Deployment** - Automatisch im `DeployStackHandler`
2. **Manuell** - Ãœber neuen API Endpoint (optional fÃ¼r v0.14)

**Integration in DeployStackHandler:**

```csharp
// Application/UseCases/Deployments/DeployStack/DeployStackHandler.cs
public async Task<DeployStackResponse> Handle(DeployStackRequest request, CancellationToken ct)
{
    // ... existing code ...

    // Wenn bereits ein Deployment existiert: Snapshot erstellen
    var existingDeployment = await _deploymentRepository.GetByStackNameAsync(
        environmentId, stackName, ct);

    if (existingDeployment != null && existingDeployment.Status == DeploymentStatus.Running)
    {
        existingDeployment.CreateSnapshot($"Before upgrade to {newVersion}");
        await _deploymentRepository.UpdateAsync(existingDeployment, ct);
    }

    // ... continue with deployment ...
}
```

---

## 4. Implementierungsreihenfolge

### Phase 1: Health Dashboard (Frontend)
1. `HealthDashboardPage.tsx` erstellen
2. `HealthSummaryCards.tsx` implementieren
3. `HealthStackCard.tsx` + `HealthServiceRow.tsx`
4. Route `/health` hinzufÃ¼gen
5. Navigation-Link hinzufÃ¼gen

### Phase 2: Health History Chart
1. Chart-Library hinzufÃ¼gen (Recharts)
2. `HealthHistoryChart.tsx` implementieren
3. In DeploymentDetail Page integrieren

### Phase 3: Rollback Backend
1. `DeploymentSnapshot` Value Object erstellen
2. `DeploymentSnapshotId` implementieren
3. Deployment Aggregate erweitern
4. EF Core Configuration + Migration
5. `GetDeploymentSnapshotsHandler` implementieren
6. `RollbackDeploymentHandler` implementieren
7. API Endpoints hinzufÃ¼gen

### Phase 4: Rollback Frontend
1. API Client erweitern
2. `VersionHistorySection.tsx` implementieren
3. `RollbackDialog.tsx` implementieren
4. In DeploymentDetail Page integrieren

### Phase 5: Automatische Snapshots
1. DeployStackHandler erweitern
2. Snapshot-Limit (max 10) implementieren

---

## 5. Tests

### Unit Tests
- `DeploymentSnapshotTests.cs` - Snapshot Creation, Limit enforcement
- `DeploymentRollbackTests.cs` - Rollback state transitions
- `GetDeploymentSnapshotsHandlerTests.cs`
- `RollbackDeploymentHandlerTests.cs`

### Integration Tests
- Snapshot persistence in SQLite
- Rollback E2E mit Docker TestContainers
- API Endpoint Tests

### Frontend Tests
- HealthDashboard rendering
- Rollback dialog flow
- Version comparison

---

## 6. Nicht im Scope von v0.14

Folgende Features werden auf spÃ¤tere Versionen verschoben:

- **Health Alerts/Notifications** â†’ v0.17 (Metrics & Audit)
- **Prometheus/Grafana Integration** â†’ v0.17
- **Partial Rollback** (nur einzelne Services) â†’ Post v1.0
- **Blue/Green Deployments** â†’ Post v1.0
- **Canary Deployments** â†’ Post v1.0
- **Rollback Approval Workflow** â†’ Post v1.0

---

## 7. AbhÃ¤ngigkeiten

### Neue NPM Packages (Frontend)
```json
{
  "recharts": "^2.15.0"  // FÃ¼r Health History Chart
}
```

### Keine neuen NuGet Packages erforderlich

Das Backend nutzt bereits:
- MediatR fÃ¼r CQRS
- EF Core fÃ¼r Persistence
- System.Text.Json fÃ¼r Serialization
