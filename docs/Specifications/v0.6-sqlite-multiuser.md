# v0.6 Spezifikation: SQLite Migration & Multi-User Support

**Status: Implementiert**

## Übersicht

Diese Version führt eine vollständige Domain-Driven Design (DDD) Architektur ein, migriert von JSON-Dateien zu SQLite und implementiert ein Multi-User-System mit rollenbasierter Zugriffskontrolle.

## Architektur

### Bounded Contexts

```
┌─────────────────────────────────────────────────────────────┐
│                    Identity & Access                         │
│  ┌─────────────────┐  ┌─────────────┐  ┌────────────────┐   │
│  │  Organization   │  │    User     │  │      Role      │   │
│  │  (Aggregate)    │  │ (Aggregate) │  │   (Aggregate)  │   │
│  └─────────────────┘  └─────────────┘  └────────────────┘   │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                       Deployment                             │
│  ┌─────────────────┐  ┌─────────────────────────────────┐   │
│  │   Environment   │  │          Deployment             │   │
│  │   (Aggregate)   │  │          (Aggregate)            │   │
│  └─────────────────┘  └─────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                    Stack Management                          │
│  ┌─────────────────┐  ┌─────────────────────────────────┐   │
│  │   StackSource   │  │       StackDefinition           │   │
│  │   (Aggregate)   │  │       (Read Model)              │   │
│  └─────────────────┘  └─────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

---

## Projektstruktur (Implementiert)

### Domain Layer

```
src/ReadyStackGo.Domain/
├── SharedKernel/                          # DDD Building Blocks
│   ├── AggregateRoot.cs                   # Basis für Aggregate Roots
│   ├── Entity.cs                          # Basis für Entities
│   ├── ValueObject.cs                     # Basis für Value Objects
│   ├── DomainEvent.cs                     # Basis für Domain Events
│   ├── IDomainEvent.cs                    # Interface für Events
│   └── AssertionConcern.cs                # Validierungs-Hilfsmethoden
│
├── IdentityAccess/                        # Identity & Access Context
│   ├── Organizations/                     # Organization Aggregate
│   │   ├── Organization.cs                # Aggregate Root
│   │   ├── OrganizationId.cs              # Typed ID
│   │   ├── OrganizationProvisioned.cs     # Domain Event
│   │   ├── OrganizationActivated.cs       # Domain Event
│   │   ├── OrganizationDeactivated.cs     # Domain Event
│   │   ├── OrganizationProvisioningService.cs  # Domain Service
│   │   └── IOrganizationRepository.cs     # Repository Interface
│   │
│   ├── Users/                             # User Aggregate
│   │   ├── User.cs                        # Aggregate Root
│   │   ├── UserId.cs                      # Typed ID
│   │   ├── EmailAddress.cs                # Value Object
│   │   ├── HashedPassword.cs              # Value Object
│   │   ├── Enablement.cs                  # Value Object
│   │   ├── RoleAssignment.cs              # Value Object
│   │   ├── IPasswordHasher.cs             # Interface
│   │   ├── UserRegistered.cs              # Domain Event
│   │   ├── UserRoleAssigned.cs            # Domain Event
│   │   ├── UserRoleRevoked.cs             # Domain Event
│   │   ├── UserPasswordChanged.cs         # Domain Event
│   │   ├── UserEnablementChanged.cs       # Domain Event
│   │   ├── AuthenticationService.cs       # Domain Service
│   │   ├── SystemAdminRegistrationService.cs  # Domain Service
│   │   └── IUserRepository.cs             # Repository Interface
│   │
│   └── Roles/                             # Role Aggregate
│       ├── Role.cs                        # Aggregate Root (mit Built-in Rollen)
│       ├── RoleId.cs                      # Typed ID
│       ├── Permission.cs                  # Value Object
│       ├── ScopeType.cs                   # Enum (Global, Organization, Environment)
│       └── IRoleRepository.cs             # Repository Interface
│
├── Deployment/                            # Deployment Context
│   ├── Environments/                      # Environment Aggregate
│   │   ├── Environment.cs                 # Aggregate Root
│   │   ├── EnvironmentId.cs               # Typed ID
│   │   ├── EnvironmentType.cs             # Enum
│   │   ├── ConnectionConfig.cs            # Value Object
│   │   ├── EnvironmentCreated.cs          # Domain Event
│   │   └── IEnvironmentRepository.cs      # Repository Interface
│   │
│   └── Deployments/                       # Deployment Aggregate
│       ├── Deployment.cs                  # Aggregate Root
│       ├── DeploymentId.cs                # Typed ID
│       ├── DeploymentStatus.cs            # Enum
│       ├── DeployedService.cs             # Entity
│       ├── DeploymentStarted.cs           # Domain Event
│       ├── DeploymentCompleted.cs         # Domain Event
│       └── IDeploymentRepository.cs       # Repository Interface
│
└── StackManagement/                       # Stack Management Context
    └── StackSources/
        ├── StackSource.cs                 # Aggregate Root
        ├── StackSourceId.cs               # Typed ID
        ├── StackSourceType.cs             # Enum
        ├── StackDefinition.cs             # Value Object
        ├── StackVariable.cs               # Value Object
        ├── IStackSourceRepository.cs      # Repository Interface
        └── IStackDefinitionRepository.cs  # Repository Interface
```

### Application Layer

```
src/ReadyStackGo.Application/
├── DependencyInjection.cs                 # MediatR Registrierung
│
├── Services/                              # Application Service Interfaces
│   ├── IDockerService.cs                  # Docker Engine Abstraktion
│   ├── IDockerComposeParser.cs            # Compose YAML Parser
│   ├── IDeploymentService.cs              # Deployment Orchestrierung
│   ├── IEnvironmentService.cs             # Environment Management
│   ├── IStackSourceService.cs             # Stack Source Management
│   ├── IStackSourceProvider.cs            # Provider Pattern
│   ├── IStackCache.cs                     # In-Memory Cache
│   └── ITokenService.cs                   # JWT Token Generation
│
└── UseCases/                              # CQRS mit MediatR
    ├── Administration/
    │   └── RegisterSystemAdmin/           # Initiale Admin-Registrierung
    │       ├── RegisterSystemAdminCommand.cs
    │       └── RegisterSystemAdminHandler.cs
    │
    ├── Authentication/
    │   └── Login/                         # User Login
    │       ├── LoginCommand.cs
    │       └── LoginHandler.cs
    │
    ├── Organizations/
    │   └── ProvisionOrganization/         # Org erstellen mit Admin
    │       ├── ProvisionOrganizationCommand.cs
    │       └── ProvisionOrganizationHandler.cs
    │
    ├── Environments/
    │   ├── CreateEnvironment/             # Environment erstellen
    │   ├── UpdateEnvironment/             # Environment aktualisieren
    │   ├── DeleteEnvironment/             # Environment löschen
    │   ├── GetEnvironment/                # Einzelnes Environment laden
    │   ├── ListEnvironments/              # Alle Environments auflisten
    │   ├── SetDefaultEnvironment/         # Default setzen
    │   ├── TestConnection/                # Docker-Verbindung testen
    │   └── EnvironmentDtos.cs             # Data Transfer Objects
    │
    ├── Deployments/
    │   ├── DeployCompose/                 # Stack deployen
    │   ├── RemoveDeployment/              # Stack entfernen
    │   ├── GetDeployment/                 # Deployment-Details
    │   ├── ListDeployments/               # Alle Deployments
    │   ├── ParseCompose/                  # Compose YAML parsen
    │   └── DeploymentDtos.cs              # DTOs inkl. DeploymentPlan
    │
    ├── Containers/
    │   ├── ListContainers/                # Container auflisten
    │   ├── StartContainer/                # Container starten
    │   ├── StopContainer/                 # Container stoppen
    │   └── ContainerDto.cs                # Container DTOs
    │
    ├── Stacks/
    │   ├── GetStack/                      # Stack-Definition laden
    │   └── ListStacks/                    # Verfügbare Stacks
    │
    ├── StackSources/
    │   ├── ListStackSources/              # Konfigurierte Sources
    │   └── SyncStackSources/              # Sources synchronisieren
    │
    ├── Dashboard/
    │   └── GetDashboardStats/             # Dashboard-Statistiken
    │
    └── Wizard/
        ├── GetWizardStatus/               # Wizard-Status abfragen
        ├── CompleteWizard/                # Wizard abschließen
        └── WizardDtos.cs                  # Wizard DTOs
```

### Infrastructure Layer

```
src/ReadyStackGo.Infrastructure/
├── DependencyInjection.cs                 # Service-Registrierung
│
├── Authentication/                        # Authentifizierung
│   ├── BCryptPasswordHasher.cs            # BCrypt Implementation
│   ├── TokenService.cs                    # JWT Token Service
│   └── JwtSettings.cs                     # JWT Konfiguration
│
├── Configuration/                         # JSON-basierte Config (reduziert)
│   ├── IConfigStore.cs                    # Interface
│   ├── ConfigStore.cs                     # Implementation
│   ├── SystemConfig.cs                    # System-Einstellungen
│   ├── TlsConfig.cs                       # TLS-Zertifikate
│   ├── FeaturesConfig.cs                  # Feature Flags
│   ├── ReleaseConfig.cs                   # Installierte Version
│   ├── WizardState.cs                     # Wizard-Zustand
│   └── DeploymentMode.cs                  # Enum
│
├── DataAccess/                            # SQLite mit EF Core
│   ├── ReadyStackGoDbContext.cs           # EF DbContext
│   ├── Configurations/                    # EF Fluent API Mappings
│   │   ├── OrganizationConfiguration.cs
│   │   ├── UserConfiguration.cs
│   │   ├── EnvironmentConfiguration.cs
│   │   └── DeploymentConfiguration.cs
│   └── Repositories/                      # Repository Implementierungen
│       ├── OrganizationRepository.cs
│       ├── UserRepository.cs
│       ├── RoleRepository.cs
│       ├── EnvironmentRepository.cs
│       └── DeploymentRepository.cs
│
├── Docker/                                # Docker Engine Integration
│   └── DockerService.cs                   # Docker.DotNet Wrapper
│
├── Manifests/                             # Release Manifeste
│   ├── IManifestProvider.cs
│   ├── ManifestProvider.cs
│   ├── ReleaseManifest.cs
│   └── DockerComposeParser.cs             # YAML Parser
│
├── Services/                              # Business Services
│   ├── IDeploymentEngine.cs               # Interface
│   ├── DeploymentEngine.cs                # Deployment Orchestrierung
│   ├── DeploymentService.cs               # High-Level Service
│   └── EnvironmentService.cs              # Environment Operations
│
├── Stacks/                                # Stack Source Management
│   ├── StackSourceService.cs              # Source Management
│   ├── InMemoryStackCache.cs              # Stack Cache
│   ├── Configuration/
│   │   └── StackSourceConfig.cs           # appsettings.json Config
│   └── Sources/
│       └── LocalDirectoryStackSourceProvider.cs
│
└── Tls/                                   # TLS Certificate Management
    ├── ITlsService.cs
    └── TlsService.cs
```

---

## Domain Model (Implementiert)

### IdentityAccess Context

#### Organization (Aggregate Root)

```csharp
public class Organization : AggregateRoot<OrganizationId>
{
    public OrganizationId Id { get; private set; }
    public string Name { get; private set; }
    public string Description { get; private set; }
    public bool Active { get; private set; }
    public DateTime CreatedAt { get; private set; }
    public DateTime? UpdatedAt { get; private set; }

    // Factory method
    public static Organization Provision(OrganizationId id, string name, string description)

    // Behaviors
    public void Activate()
    public void Deactivate()
    public void UpdateDescription(string description)
}
```

#### User (Aggregate Root)

```csharp
public class User : AggregateRoot<UserId>
{
    public UserId Id { get; private set; }
    public string Username { get; private set; }
    public EmailAddress Email { get; private set; }
    public HashedPassword Password { get; private set; }
    public Enablement Enablement { get; private set; }
    public DateTime CreatedAt { get; private set; }
    public DateTime? UpdatedAt { get; private set; }

    private readonly List<RoleAssignment> _roleAssignments;
    public IReadOnlyCollection<RoleAssignment> RoleAssignments => _roleAssignments.AsReadOnly();

    // Factory method
    public static User Register(UserId id, string username, EmailAddress email, HashedPassword password)

    // Behaviors
    public void AssignRole(RoleAssignment assignment)
    public void RevokeRole(RoleId roleId, ScopeType scopeType, string? scopeId)
    public void ChangePassword(HashedPassword newPassword)
    public void Enable()
    public void Disable()
    public bool HasPermission(Permission permission, ScopeType scopeType, string? scopeId)
    public RoleId? GetPrimaryRole()
}
```

**Hinweis**: User ist nicht mehr an eine Organization gebunden (im Gegensatz zur ursprünglichen Tenant-Konzept). Stattdessen werden Berechtigungen über RoleAssignments mit Scopes gesteuert.

#### Role (Aggregate mit Built-in Rollen)

```csharp
public class Role : AggregateRoot<RoleId>
{
    public RoleId Id { get; private set; }
    public string Name { get; private set; }
    public string Description { get; private set; }
    public ScopeType AllowedScopes { get; private set; }
    public IReadOnlyCollection<Permission> Permissions { get; }

    // Built-in Rollen (read-only)
    public static RoleId SystemAdmin { get; }   // Globaler Admin
    public static RoleId OrgOwner { get; }      // Organization Owner
    public static RoleId Operator { get; }      // Stack-Operator
    public static RoleId Viewer { get; }        // Nur-Lesen
}

[Flags]
public enum ScopeType
{
    Global = 1,
    Organization = 2,
    Environment = 4
}
```

### Deployment Context

#### Environment (Aggregate Root)

```csharp
public class Environment : AggregateRoot<EnvironmentId>
{
    public EnvironmentId Id { get; private set; }
    public OrganizationId OrganizationId { get; private set; }
    public string Name { get; private set; }
    public string Description { get; private set; }
    public EnvironmentType Type { get; private set; }
    public string ConnectionString { get; private set; }
    public bool IsDefault { get; private set; }
    public DateTime CreatedAt { get; private set; }

    // Factory methods
    public static Environment CreateDockerSocket(EnvironmentId id, OrganizationId orgId,
        string name, string description, string socketPath)
    public static Environment CreateDockerApi(EnvironmentId id, OrganizationId orgId,
        string name, string description, string apiUrl)

    // Behaviors
    public void SetAsDefault()
    public void UnsetAsDefault()
    public void Update(string name, string description, string connectionString)
}

public enum EnvironmentType
{
    DockerSocket = 0,
    DockerApi = 1
}
```

#### Deployment (Aggregate Root)

```csharp
public class Deployment : AggregateRoot<DeploymentId>
{
    public DeploymentId Id { get; private set; }
    public EnvironmentId EnvironmentId { get; private set; }
    public string StackName { get; private set; }
    public string ProjectName { get; private set; }
    public DeploymentStatus Status { get; private set; }
    public string? ErrorMessage { get; private set; }
    public DateTime CreatedAt { get; private set; }
    public DateTime? CompletedAt { get; private set; }

    private readonly List<DeployedService> _services;
    public IReadOnlyCollection<DeployedService> Services => _services.AsReadOnly();

    // Factory method
    public static Deployment Start(DeploymentId id, EnvironmentId envId,
        string stackName, string projectName)

    // Behaviors
    public void MarkAsRunning(IEnumerable<DeployedService> services)
    public void MarkAsFailed(string errorMessage)
    public void MarkAsStopped()
    public void MarkAsRemoved()
}

public enum DeploymentStatus
{
    Pending = 0,
    Running = 1,
    Stopped = 2,
    Failed = 3,
    Removed = 4
}
```

### StackManagement Context

#### StackSource (Aggregate Root)

```csharp
public class StackSource
{
    public StackSourceId Id { get; }
    public string Name { get; }
    public StackSourceType Type { get; }
    public string Configuration { get; }  // JSON
    public bool Enabled { get; }
    public DateTime? LastSyncAt { get; }
}

public enum StackSourceType
{
    LocalDirectory = 0,
    GitRepository = 1
}
```

#### StackDefinition (Value Object)

```csharp
public class StackDefinition
{
    public string Id { get; }
    public string Name { get; }
    public string Description { get; }
    public string Category { get; }
    public string ComposeContent { get; }
    public IReadOnlyList<StackVariable> Variables { get; }
    public string SourceId { get; }
}
```

---

## Domain Services

### AuthenticationService

```csharp
public class AuthenticationService
{
    private readonly IUserRepository _userRepository;
    private readonly IPasswordHasher _passwordHasher;

    public User? Authenticate(string username, string password)
    {
        var user = _userRepository.FindByUsername(username);
        if (user == null) return null;
        if (!user.Enablement.IsEnabled) return null;
        if (!user.Password.Verify(password, _passwordHasher)) return null;
        return user;
    }
}
```

### SystemAdminRegistrationService

```csharp
public class SystemAdminRegistrationService
{
    private readonly IUserRepository _userRepository;
    private readonly IPasswordHasher _passwordHasher;

    public User RegisterSystemAdmin(UserId userId, string username, string email, string password)
    {
        // Validation: nur ein SystemAdmin erlaubt
        if (_userRepository.AnyUserExists())
            throw new InvalidOperationException("System admin already exists");

        var hashedPassword = HashedPassword.Create(password, _passwordHasher);
        var user = User.Register(userId, username, new EmailAddress(email), hashedPassword);
        user.AssignRole(RoleAssignment.Global(RoleId.SystemAdmin));

        _userRepository.Add(user);
        return user;
    }
}
```

### OrganizationProvisioningService

```csharp
public class OrganizationProvisioningService
{
    private readonly IOrganizationRepository _organizationRepository;

    public Organization ProvisionOrganization(OrganizationId id, string name, string description)
    {
        // Validation
        if (_organizationRepository.ExistsByName(name))
            throw new InvalidOperationException($"Organization '{name}' already exists");

        var org = Organization.Provision(id, name, description);
        org.Activate();

        _organizationRepository.Add(org);
        return org;
    }
}
```

---

## Application Layer UseCases

### Administration

| UseCase | Typ | Beschreibung |
|---------|-----|--------------|
| RegisterSystemAdmin | Command | Registriert den initialen System-Administrator |

### Authentication

| UseCase | Typ | Beschreibung |
|---------|-----|--------------|
| Login | Command | Authentifiziert User und gibt JWT zurück |

### Organizations

| UseCase | Typ | Beschreibung |
|---------|-----|--------------|
| ProvisionOrganization | Command | Erstellt eine neue Organization |

### Environments

| UseCase | Typ | Beschreibung |
|---------|-----|--------------|
| CreateEnvironment | Command | Erstellt ein neues Environment |
| UpdateEnvironment | Command | Aktualisiert Environment-Einstellungen |
| DeleteEnvironment | Command | Löscht ein Environment |
| SetDefaultEnvironment | Command | Setzt Default-Environment |
| TestConnection | Command | Testet Docker-Verbindung |
| GetEnvironment | Query | Lädt ein Environment |
| ListEnvironments | Query | Listet alle Environments |

### Deployments

| UseCase | Typ | Beschreibung |
|---------|-----|--------------|
| DeployCompose | Command | Deployt einen Stack aus Compose YAML |
| RemoveDeployment | Command | Entfernt einen Stack |
| ParseCompose | Command | Parst Compose YAML für Preview |
| GetDeployment | Query | Lädt Deployment-Details |
| ListDeployments | Query | Listet alle Deployments |

### Containers

| UseCase | Typ | Beschreibung |
|---------|-----|--------------|
| StartContainer | Command | Startet einen Container |
| StopContainer | Command | Stoppt einen Container |
| ListContainers | Query | Listet alle Container |

### Wizard

| UseCase | Typ | Beschreibung |
|---------|-----|--------------|
| CompleteWizard | Command | Schließt Wizard ab, erstellt Org+Admin |
| GetWizardStatus | Query | Prüft ob Wizard abgeschlossen ist |

---

## Rollen & Berechtigungen

| Rolle | Scope | Beschreibung | Berechtigungen |
|-------|-------|--------------|----------------|
| SystemAdmin | Global | System-Administrator | Alles |
| OrgOwner | Organization | Org-Besitzer | Users, Environments, Stacks innerhalb der Org |
| Operator | Org/Environment | Stack-Operator | Deploy, Start, Stop, Remove Stacks |
| Viewer | Org/Environment | Nur Lesen | Lesen aller Ressourcen im Scope |

---

## Konfiguration

### SQLite (EF Core)

Alle dynamischen Daten werden in SQLite gespeichert:
- Organizations
- Users (inkl. RoleAssignments)
- Environments
- Deployments

### JSON-Dateien (reduziert)

Nur noch statische Konfiguration in JSON:

| Datei | Inhalt |
|-------|--------|
| rsgo.system.json | BaseUrl, Ports, Network, WizardState |
| rsgo.tls.json | TLS-Zertifikate |
| rsgo.features.json | Feature Flags |
| rsgo.release.json | Installierte Stack-Version |

**Entfernt seit v0.6:**
- ~~rsgo.contexts.json~~ (seit v0.4 obsolet)
- ~~rsgo.security.json~~ (ersetzt durch SQLite Users)
- ~~rsgo.organization.json~~ (ersetzt durch SQLite Organizations)

---

## Implementierungsfortschritt

### Phase 1: Domain Layer ✅
- [x] SharedKernel (AggregateRoot, Entity, ValueObject, DomainEvent)
- [x] IdentityAccess Context (Organization, User, Role)
- [x] Deployment Context (Environment, Deployment)
- [x] StackManagement Context (StackSource, StackDefinition)
- [x] Reqnroll Tests für Domain-Logik

### Phase 2: Infrastructure Layer ✅
- [x] EF Core DbContext mit SQLite
- [x] Repository Implementierungen
- [x] Entity Configurations (Fluent API)
- [x] Integration Tests

### Phase 3: Application Layer ✅
- [x] MediatR für CQRS
- [x] UseCase Handler
- [x] DTOs
- [x] Wizard Integration

### Phase 4: Cleanup ✅
- [x] Obsolete ContextsConfig entfernt
- [x] Infrastructure Layer reorganisiert (technische Struktur)
- [x] Dokumentation aktualisiert

---

## Tests

### Domain Tests (Reqnroll/SpecFlow)

```
tests/ReadyStackGo.IntegrationTests/
├── Features/
│   ├── OrganizationProvisioning.feature
│   ├── UserAuthentication.feature
│   ├── UserRoleManagement.feature
│   └── EnvironmentManagement.feature
└── StepDefinitions/
    └── ...
```

### Unit Tests

```
tests/ReadyStackGo.UnitTests/
├── DeploymentEngineTests.cs
├── Stacks/
│   ├── LocalDirectoryStackSourceProviderTests.cs
│   └── VariablePriorityTests.cs
└── ...
```

---

## Offene Punkte (für v0.7+)

- [ ] JWT Token Refresh Strategie
- [ ] Audit Logging für Security Events
- [ ] Password Reset Flow
- [ ] User Self-Service
- [ ] Multi-Environment Deployments
- [ ] GitRepository StackSourceProvider
