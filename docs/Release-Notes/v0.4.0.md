# Release Notes: v0.4.0

**Release Date:** TBD
**Status:** üöß Planning

---

## Overview

Version 0.4.0 introduces **Multi-Environment Support**, enabling organizations to manage multiple isolated environments (Development, Test, Production) with independent configurations, Docker hosts, and deployed stacks.

This release focuses on a **minimal viable multi-environment implementation** with a single Docker host per environment. Multi-node orchestration is deferred to v0.5.

---

## üéØ Key Features

### 1. Multi-Environment Architecture

Organizations can now create and manage multiple environments, each with:

- **Independent Connection Strings:** Separate Transport, Persistence, and EventStore configurations
- **Dedicated Docker Host:** Each environment connects to its own Docker daemon
- **Isolated Deployments:** Stacks and containers are scoped per environment
- **Environment Context:** UI shows only the active environment's resources

**Example Use Case:**
```
Organization: "Acme Corp"
‚îú‚îÄ‚îÄ Development Environment
‚îÇ   ‚îú‚îÄ‚îÄ Docker Host: tcp://dev-docker.acme.local:2375  ‚Üê Unique Docker host
‚îÇ   ‚îú‚îÄ‚îÄ Database: dev-postgres.acme.local
‚îÇ   ‚îî‚îÄ‚îÄ Message Bus: dev-rabbitmq.acme.local
‚îú‚îÄ‚îÄ Test Environment
‚îÇ   ‚îú‚îÄ‚îÄ Docker Host: tcp://test-docker.acme.local:2375  ‚Üê Unique Docker host
‚îÇ   ‚îú‚îÄ‚îÄ Database: test-postgres.acme.local
‚îÇ   ‚îî‚îÄ‚îÄ Message Bus: test-rabbitmq.acme.local
‚îî‚îÄ‚îÄ Production Environment (Default)
    ‚îú‚îÄ‚îÄ Docker Host: tcp://prod-docker.acme.local:2375  ‚Üê Unique Docker host
    ‚îú‚îÄ‚îÄ Database: prod-postgres.acme.local
    ‚îî‚îÄ‚îÄ Message Bus: prod-rabbitmq.acme.local
```

**Important:** Each environment must have a unique Docker host URL. Two environments cannot share the same Docker daemon to prevent container conflicts and ensure proper isolation.

---

### 2. Environment Management UI

#### Environment Selector (Header Dropdown)

A new dropdown in the dashboard header allows users to switch between environments instantly:

- **Active Environment Indicator:** Shows currently selected environment
- **Quick Switching:** One-click environment context change
- **Default Environment Badge:** Clearly marks the default environment
- **Docker Host Preview:** Displays Docker host URL in selector

**UI Location:** Top-right header, next to user menu

**Behavior:**
- Persists selected environment in localStorage
- Automatically refreshes dashboard, containers, and stacks when switched
- Defaults to "Default" environment on first login

#### Environment Settings Page

**Location:** Settings ‚Üí Environments

**Features:**
- **List All Environments:** Table view with Name, Docker Host, Default status
- **Create Environment:** Modal form with validation
  - Environment ID (lowercase alphanumeric + hyphens)
  - Environment Name (display name)
  - Docker Host URL (tcp:// or unix://)
  - Test Connection button (validates Docker host accessibility)
- **Edit Environment:** Update name and Docker host
- **Delete Environment:** Remove environment (protected if default or has deployments)
- **Set Default:** Designate which environment is default

---

### 3. Per-Environment Configuration

#### New Configuration File Structure

**Before (v0.3):**
```
/app/config/
  rsgo.system.json
  rsgo.security.json
  rsgo.contexts.json     ‚Üê Single file for all connections
  rsgo.tls.json
```

**After (v0.4):**
```
/app/config/
  rsgo.system.json       ‚Üê Now includes environments array
  rsgo.security.json
  rsgo.contexts.production.json  ‚Üê Per-environment
  rsgo.contexts.test.json
  rsgo.contexts.dev.json
  rsgo.tls.json
```

#### System Configuration Changes

**New Schema (`rsgo.system.json`):**
```json
{
  "organizationId": "acme-corp",
  "organizationName": "Acme Corp",
  "wizardState": "Installed",
  "installedVersion": "v0.4.0",
  "createdAt": "2025-01-19T10:30:00Z",
  "updatedAt": "2025-01-25T14:00:00Z",
  "environments": [
    {
      "id": "production",
      "name": "Production",
      "dockerHost": "tcp://prod-docker.acme.local:2375",
      "isDefault": true,
      "createdAt": "2025-01-19T10:35:00Z"
    },
    {
      "id": "test",
      "name": "Test Environment",
      "dockerHost": "tcp://test-docker.acme.local:2375",
      "isDefault": false,
      "createdAt": "2025-01-25T14:00:00Z"
    }
  ]
}
```

#### Per-Environment Context Files

**Example: `rsgo.contexts.production.json`**
```json
{
  "environmentId": "production",
  "connectionMode": "Simple",
  "simple": {
    "transport": "amqp://prod-rabbitmq.acme.local:5672",
    "persistence": "Host=prod-postgres.acme.local;Port=5432;Database=rsgo;Username=admin;Password=***",
    "eventStore": "esdb://prod-eventstore.acme.local:2113?tls=false"
  },
  "advanced": null
}
```

---

### 4. Enhanced Setup Wizard

#### Wizard Flow Changes

**v0.3 Wizard (4 Steps):**
1. Create Admin Account
2. Set Organization
3. Configure Connections
4. Complete Setup

**v0.4 Wizard (4 Steps - Reorganized):**
1. Create Admin Account
2. **Set Organization & Default Environment** ‚Üê Combined Step
   - Organization ID
   - Organization Name
   - Default Environment ID (e.g., "production")
   - Default Environment Name (e.g., "Production")
   - Docker Host URL
3. Configure Connections (scoped to default environment)
4. Complete Setup

**Rationale:** Combining Organization + Environment setup keeps wizard concise while introducing environment concept early.

#### Default Environment Auto-Creation

- Wizard creates first environment during Step 2
- Auto-generates environment ID: `production` (default)
- Auto-generates environment name: `Production` (default)
- User can customize both IDs and names
- First environment is always marked as default (`isDefault: true`)

---

### 5. API Enhancements

#### New Endpoints

**Get All Environments**
```http
GET /api/environments
Authorization: Bearer {token}

Response 200 OK:
{
  "environments": [
    {
      "id": "production",
      "name": "Production",
      "dockerHost": "tcp://192.168.1.10:2375",
      "isDefault": true,
      "createdAt": "2025-01-19T10:35:00Z"
    }
  ]
}
```

**Create Environment**
```http
POST /api/environments
Authorization: Bearer {token}

{
  "id": "staging",
  "name": "Staging",
  "dockerHost": "tcp://192.168.1.30:2375"
}

Response 201 Created
```

**Update Environment**
```http
PUT /api/environments/{id}
Authorization: Bearer {token}

{
  "name": "Staging (Updated)",
  "dockerHost": "tcp://192.168.1.35:2375"
}

Response 200 OK
```

**Delete Environment**
```http
DELETE /api/environments/{id}
Authorization: Bearer {token}

Response 204 No Content
```

**Test Docker Host Connection**
```http
POST /api/environments/test-connection
Authorization: Bearer {token}

{
  "dockerHost": "tcp://192.168.1.40:2375"
}

Response 200 OK:
{
  "success": true,
  "message": "Connection successful"
}
```

#### Modified Endpoints (Environment-Scoped)

**List Containers (Environment-Scoped)**
```http
# v0.3
GET /api/containers

# v0.4
GET /api/containers?environment=production
```

**Deploy Stack (Environment-Scoped)**
```http
# v0.4
POST /api/deployments
{
  "environmentId": "production",  ‚Üê NEW REQUIRED FIELD
  "manifestPath": "/app/manifests/v1.0.0.json"
}
```

---

### 6. Automatic Migration from v0.3

#### Migration Logic

When upgrading from v0.3 to v0.4, the system automatically:

1. **Detects v0.3 Installation:** Checks if `rsgo.system.json` has no `environments` array
2. **Creates Default Environment:**
   - ID: `production`
   - Name: `Production`
   - Docker Host: `unix:///var/run/docker.sock` (default, customizable)
   - Is Default: `true`
3. **Migrates Connection Strings:**
   - Renames `rsgo.contexts.json` ‚Üí `rsgo.contexts.production.json`
   - Adds `environmentId: "production"` field
4. **Backups Old Config:**
   - Creates `rsgo.contexts.json.v0.3.backup`
5. **Updates System Config:**
   - Adds `environments` array
   - Updates `installedVersion` to `v0.4.0`

#### Migration Log Example

```
info: Configuration migration detected. Version: v0.3.0 ‚Üí v0.4.0
info: Creating default environment: production
info: Migrating connection strings to environment: production
info: Renamed: rsgo.contexts.json ‚Üí rsgo.contexts.production.json
info: Backup created: rsgo.contexts.json.v0.3.backup
info: System config updated with environments array
info: Migration completed successfully. Total duration: 45ms
```

**User Experience:**
- Zero downtime during migration
- No user action required
- Existing logins remain valid
- Dashboard shows new "Production" environment automatically

---

## üèóÔ∏è Architecture Changes

### New Services

#### `IEnvironmentService`

```csharp
public interface IEnvironmentService
{
    Task<List<Environment>> GetAllEnvironmentsAsync();
    Task<Environment?> GetEnvironmentAsync(string environmentId);
    Task<Environment> CreateEnvironmentAsync(CreateEnvironmentRequest request);
    Task<Environment> UpdateEnvironmentAsync(string environmentId, UpdateEnvironmentRequest request);
    Task DeleteEnvironmentAsync(string environmentId);
    Task<Environment> GetDefaultEnvironmentAsync();
    Task SetDefaultEnvironmentAsync(string environmentId);
}
```

**Responsibilities:**
- CRUD operations for environments
- Default environment management
- Environment validation (unique IDs, format compliance)

### Modified Services

#### `IConfigStore` (Extended)

```csharp
// v0.3
Task<ContextsConfig> GetContextsConfigAsync();
Task SaveContextsConfigAsync(ContextsConfig config);

// v0.4 - Added overloads
Task<ContextsConfig> GetContextsConfigAsync(string environmentId);
Task SaveContextsConfigAsync(string environmentId, ContextsConfig config);
```

#### `IDockerService` (Environment-Aware)

```csharp
// v0.3
Task<List<ContainerInfo>> ListContainersAsync();

// v0.4
Task<List<ContainerInfo>> ListContainersAsync(string environmentId);
Task<bool> TestConnectionAsync(string dockerHostUrl); // NEW
```

**Behavior:**
- All Docker operations now require `environmentId` parameter
- Docker client instances created per environment's Docker host
- Connection pooling for performance (future optimization)

### New Domain Models

```csharp
public class Environment
{
    public string Id { get; set; } = string.Empty;
    public string Name { get; set; } = string.Empty;
    public string DockerHost { get; set; } = string.Empty;
    public bool IsDefault { get; set; }
    public DateTime CreatedAt { get; set; }
}

public class CreateEnvironmentRequest
{
    public string Id { get; set; } = string.Empty;
    public string Name { get; set; } = string.Empty;
    public string DockerHost { get; set; } = string.Empty;
}

public class UpdateEnvironmentRequest
{
    public string Name { get; set; } = string.Empty;
    public string DockerHost { get; set; } = string.Empty;
}
```

---

## üé® Frontend Changes

### New Components

#### `EnvironmentSelector.tsx`

Dropdown component in dashboard header for switching environments.

**Props:**
- None (uses `useEnvironment` hook for state)

**Features:**
- Shows active environment name
- Dropdown menu with all environments
- Default environment badge
- Docker host preview on hover
- "Manage Environments" link to settings

**Example Usage:**
```tsx
import EnvironmentSelector from '@/components/EnvironmentSelector';

<DashboardLayout>
  <Header>
    <EnvironmentSelector />
  </Header>
</DashboardLayout>
```

### New Hooks

#### `useEnvironment()`

Context-based hook for managing environment state.

**API:**
```typescript
const {
  environments,          // List<Environment>
  activeEnvironment,     // Environment | null
  setActiveEnvironment,  // (id: string) => void
  refreshEnvironments    // () => Promise<void>
} = useEnvironment();
```

**Behavior:**
- Loads all environments on mount
- Persists active environment ID in localStorage
- Auto-selects default environment if none active
- Provides global environment context to entire app

### Modified Pages

#### `ContainersPage.tsx`

Now filters containers by active environment:

```tsx
const { activeEnvironment } = useEnvironment();

useEffect(() => {
  if (activeEnvironment) {
    loadContainers(activeEnvironment.id);
  }
}, [activeEnvironment]);
```

#### `DashboardLayout.tsx`

Adds `EnvironmentSelector` to header:

```tsx
<header>
  <Logo />
  <EnvironmentSelector />  {/* NEW */}
  <UserMenu />
</header>
```

---

## üß™ Testing

### New Test Coverage

#### Integration Tests
- `EnvironmentEndpointsIntegrationTests.cs`
  - GET /api/environments returns all environments
  - POST /api/environments creates new environment
  - PUT /api/environments/{id} updates environment
  - DELETE /api/environments/{id} deletes environment
  - DELETE fails for default environment
  - DELETE fails if environment has active deployments
  - Test Docker host connection validation

#### E2E Tests (Playwright)
- `environment-selector.spec.ts`
  - Environment selector dropdown interaction
  - Switch between environments updates dashboard
  - Create new environment via Settings page
  - Edit existing environment
  - Delete non-default environment
  - Prevent deletion of default environment
  - Test Docker connection before saving

#### Migration Tests
- `MigrationServiceTests.cs`
  - Detect v0.3 configuration
  - Create default environment during migration
  - Migrate rsgo.contexts.json to rsgo.contexts.production.json
  - Backup old config file
  - Update system config with environments array

**Test Coverage Goals:**
- Backend: 95%+
- Frontend: 90%+

---

## üìã Known Limitations (v0.4)

### By Design (Deferred to Future Releases)

1. **Single Docker Host per Environment**
   - Each environment connects to exactly one Docker daemon
   - Multi-node orchestration deferred to v0.5

2. **Simple Connection Mode Only**
   - All bounded contexts share the same connection strings
   - Per-context configuration (Advanced mode) planned for v0.6

3. **Basic Docker Host Authentication**
   - Supports TCP and Unix socket connections only
   - TLS-secured Docker hosts deferred to v0.5

4. **No Environment Templates**
   - Cannot clone environments
   - Cannot create environments from templates
   - Planned for v0.6

5. **No Cross-Environment Operations**
   - Cannot promote deployments between environments
   - Cannot compare configurations across environments
   - Planned for v0.6

### Potential Issues

1. **Docker Host Uniqueness:**
   - Each Docker host URL can only be assigned to one environment
   - Attempting to create an environment with an already-used Docker host will fail
   - This prevents container conflicts and ensures proper environment isolation

2. **Environment Deletion:**
   - Deleting an environment does NOT automatically clean up deployed containers
   - Users must manually stop/remove containers before deleting environment

3. **Docker Host Connectivity:**
   - No automatic retry logic if Docker host becomes unreachable
   - Dashboard may show stale data if Docker host is down

---

## üîÑ Migration Guide (v0.3 ‚Üí v0.4)

### Automatic Migration (Recommended)

**Steps:**
1. Backup your `/app/config/` directory
2. Stop ReadyStackGo v0.3 container
3. Pull ReadyStackGo v0.4 image
4. Start ReadyStackGo v0.4 container with same volume mounts
5. Check logs for migration success message
6. Verify default "Production" environment created
7. Login and confirm dashboard shows new environment selector

**Expected Log Output:**
```
info: Detected v0.3 configuration. Starting migration to v0.4...
info: Creating default environment: production
info: Migrating connection strings...
info: Configuration migration completed successfully.
info: ReadyStackGo v0.4.0 is ready.
```

### Manual Migration (If Automatic Fails)

If automatic migration fails, manually update configuration:

**1. Update `rsgo.system.json`:**

Add `environments` array:
```json
{
  "organizationId": "your-org",
  "organizationName": "Your Organization",
  "wizardState": "Installed",
  "installedVersion": "v0.4.0",
  "environments": [
    {
      "id": "production",
      "name": "Production",
      "dockerHost": "unix:///var/run/docker.sock",
      "isDefault": true,
      "createdAt": "2025-01-25T10:00:00Z"
    }
  ]
}
```

**2. Rename contexts file:**
```bash
mv /app/config/rsgo.contexts.json /app/config/rsgo.contexts.production.json
```

**3. Update contexts file:**

Add `environmentId` field:
```json
{
  "environmentId": "production",
  "connectionMode": "Simple",
  "simple": { ... }
}
```

**4. Restart container**

---

## üöÄ Deployment

### Docker Compose Example

```yaml
version: '3.8'

services:
  readystackgo:
    image: readystackgo:v0.4.0
    ports:
      - "7255:7255"  # HTTPS
      - "5259:5259"  # HTTP
    volumes:
      - rsgo-config:/app/config
      - /var/run/docker.sock:/var/run/docker.sock  # Local Docker host
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - Hostname=admin.yourdomain.com

volumes:
  rsgo-config:
```

### Multi-Environment Docker Setup

For managing multiple Docker hosts:

```yaml
# Production Docker Host (192.168.1.10)
version: '3.8'
services:
  api:
    image: acme/api:1.0.0
    networks:
      - rsgo-net

# Test Docker Host (192.168.1.20)
version: '3.8'
services:
  api:
    image: acme/api:1.0.0-rc1
    networks:
      - rsgo-net
```

Configure ReadyStackGo environments:
- Production env ‚Üí `tcp://192.168.1.10:2375`
- Test env ‚Üí `tcp://192.168.1.20:2375`

---

## üìö Documentation Updates

### New Documentation
- [v0.4 Multi-Environment Specification](../Specifications/v0.4-multi-environment.md)
- This release notes document

### Updated Documentation
- [README.md](../../README.md) - Updated feature list
- [CHANGELOG.md](../../CHANGELOG.md) - Added v0.4 section
- [v0.3.0 Release Notes](v0.3.0.md) - Added "What's Next" section

---

## üîú What's Next (v0.5)

### Container Deployment
- Actual stack deployment from manifests
- Docker network creation and management
- Container health monitoring
- Deployment rollback capabilities

### Multi-Node Support
- Multiple Docker hosts per environment
- Load balancing across nodes
- Node health monitoring
- Distributed container orchestration

### Enhanced Security
- TLS-secured Docker host connections
- Certificate-based authentication
- Encrypted connection strings

---

## üìÑ License

MIT License - See [LICENSE](../../LICENSE) for details.
