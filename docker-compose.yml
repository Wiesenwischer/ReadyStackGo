services:
  readystackgo:
    image: wiesenwischer/readystackgo:${TAG:-latest}
    build:
      context: .
      dockerfile: Dockerfile
    container_name: readystackgo
    ports:
      - "8080:8080"
      - "8443:8443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ~/.docker/config.json:/root/.docker/config.json:ro
      - rsgo-config:/app/config
      - rsgo-data:/app/data
      - rsgo-git-cache:/root/.rsgo/git-cache
      - ./stacks:/app/stacks
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - ConfigPath=/app/config
      - ConnectionStrings__ReadyStackGo=Data Source=/app/data/readystackgo.db
      # Docker registry credentials (optional, set via .env file or environment)
      # - Docker__Username=${DOCKER_USERNAME}
      # - Docker__Password=${DOCKER_PASSWORD}
    restart: unless-stopped
    networks:
      - rsgo-net

  # Development: Frontend-only (Hot Reload)
  readystackgo-dev-frontend:
    image: node:20-alpine
    container_name: readystackgo-dev-frontend
    working_dir: /app
    command: npm run dev -- --host
    ports:
      - "5173:5173"
    volumes:
      - ./src/ReadyStackGo.WebUI:/app
    environment:
      - NODE_ENV=development
    networks:
      - rsgo-net
    profiles:
      - dev

  # Development: Backend-only
  readystackgo-dev-backend:
    image: mcr.microsoft.com/dotnet/sdk:9.0
    container_name: readystackgo-dev-backend
    working_dir: /app
    command: dotnet watch run --project src/ReadyStackGo.Api/ReadyStackGo.Api.csproj
    ports:
      - "8080:8080"
    volumes:
      - .:/app
      - /var/run/docker.sock:/var/run/docker.sock
      - rsgo-config-dev:/app/config
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
    networks:
      - rsgo-net
    profiles:
      - dev

volumes:
  rsgo-config:
    name: rsgo-config
  rsgo-data:
    name: rsgo-data
  rsgo-git-cache:
    name: rsgo-git-cache
  rsgo-config-dev:
    name: rsgo-config-dev

networks:
  rsgo-net:
    name: rsgo-net
    driver: bridge
