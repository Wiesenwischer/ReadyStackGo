# Business Stack Fragment
# This is a fragment (no productVersion) - only loadable via include
# Contains: Planning, Sales, Collaboration, Monitoring services

metadata:
  name: Business Services
  description: ams.project business services (Planning, Sales, Collaboration)
  category: Business
  tags:
    - planning
    - sales
    - collaboration
    - monitoring

# Note: Maintenance configuration is defined at product level in stack.yaml
# All stacks in this product share the same maintenance state.

variables:
  EVENTSTORE_DB:
    label: EventStore Connection (TCP)
    description: EventStore TCP connection string for event sourcing
    type: ConnectionString
    default: "ConnectTo=tcp://admin:changeit@eventstore:1113"
    group: Infrastructure
    order: 1

  GRPC_EVENTSTORE_DB:
    label: EventStore Connection (gRPC)
    description: EventStore gRPC connection string for Discussions API
    type: ConnectionString
    default: "esdb://admin:changeit@eventstore.db:2113?tls=false"
    group: Infrastructure
    order: 2

  REDIS_DB:
    label: Redis Connection
    description: Redis cache connection string
    type: ConnectionString
    default: "cachedata:6379"
    group: Infrastructure
    order: 3

services:
  # ===========================================
  # MONITORING
  # ===========================================
  healthmonitor:
    image: amssolution/itops.healthmonitor:linux-v3-pre
    restart: always
    ports:
      - "5100:80"
    volumes:
      - healthdata:/app/data
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://0.0.0.0:80
      Serilog__MinimumLevel: ${MIN_LOG_LEVEL}

  watchdog:
    image: amssolution/watchdog:linux-v2.5.0-pre.31
    restart: always
    ports:
      - "5101:80"
      - "161:161/udp"
    environment:
      ConnectionStrings__Monitoring: ${AMS_DB}
      SNMP_COMMUNITY: public
      SNMP_PORT: "161"
      ASPNETCORE_URLS: http://0.0.0.0:80
      HealthCheckAddresses__0: http://projectmanagement/hc
      HealthCheckAddresses__1: http://projectmanagement-api/hc
      Serilog__LogstashUrl: http://${AMS_PROJECT_EXTERNAL_DNS_NAME_OR_IP}:8080
      Serilog__MinimumLevel: ${MIN_LOG_LEVEL}

  # ===========================================
  # BFF (Backend for Frontend)
  # ===========================================
  desktopschedulingapigw:
    image: amssolution/desktopschedulingapigw:linux-v3.0.1
    restart: always
    ports:
      - "5200:80"
      - "15200:9901"
      - "10000:10000"

  desktopprojectplanningcomposition:
    image: amssolution/desktop.projectplanning.compositiongateway:linux-v3.0.1
    restart: always
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://0.0.0.0:80
      Urls__ProjectManagement: http://projectmanagement-api
      Urls__SalesOrders: http://salesorders-api
      Serilog__LogstashUrl: http://${AMS_PROJECT_EXTERNAL_DNS_NAME_OR_IP}:8080
      Serilog__MinimumLevel: ${MIN_LOG_LEVEL}

  clienthub:
    image: amssolution/itops.clienthub:linux-v3.0.1
    restart: always
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://0.0.0.0:80
      ConnectionStrings__ams: ${AMS_DB}
      Serilog__LogstashUrl: http://${AMS_PROJECT_EXTERNAL_DNS_NAME_OR_IP}:8080
      Serilog__MinimumLevel: ${MIN_LOG_LEVEL}

  # ===========================================
  # COLLABORATION
  # ===========================================
  collaboration-api:
    image: amssolution/collaboration.api:linux-v3.0.1
    restart: always
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://0.0.0.0:80
      ConnectionStrings__ams: ${AMS_DB}
      Serilog__LogstashUrl: http://${AMS_PROJECT_EXTERNAL_DNS_NAME_OR_IP}:8080
      Serilog__MinimumLevel: ${MIN_LOG_LEVEL}

  # ===========================================
  # PLANNING - CAPACITY UTILIZATION
  # ===========================================
  planning-capacityutilization-api:
    image: amssolution/planning.capacityutilization.api:linux-v3.0.1
    restart: always
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://0.0.0.0:80
      ConnectionStrings__ams: ${AMS_DB}
      Serilog__LogstashUrl: http://${AMS_PROJECT_EXTERNAL_DNS_NAME_OR_IP}:8080
      Serilog__MinimumLevel: ${MIN_LOG_LEVEL}

  # ===========================================
  # PLANNING - PROJECTS
  # ===========================================
  projectmanagement-api:
    image: amssolution/projectmanagement.api:linux-v3.0.1
    restart: always
    ports:
      - "3080:80"
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://0.0.0.0:80
      ServiceBusTimeToWaitBeforeTriggeringCircuitBreaker: ${SERVICE_BUS_TIME_TO_WAIT_BEFORE_TRIGGERING_CIRCUIT_BREAKER}
      ExitOnCriticalError: ${EXIT_ON_CRITICAL_ERROR}
      IdentityServerUrl: http://identity-api
      ConnectionStrings__ProjectManagement: ${AMS_DB}
      ConnectionStrings__Cache: ${REDIS_DB}
      ConnectionStrings__EventStore: ${EVENTSTORE_DB}
      Serilog__LogstashUrl: http://${AMS_PROJECT_EXTERNAL_DNS_NAME_OR_IP}:8080
      Serilog__MinimumLevel: ${MIN_LOG_LEVEL}
      RunMigrations: "True"
    depends_on:
      - cachedata

  projectmanagement:
    image: amssolution/projectmanagement:linux-v3.0.1
    restart: always
    ports:
      - "3081:80"
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://0.0.0.0:80
      ServiceBusTimeToWaitBeforeTriggeringCircuitBreaker: ${SERVICE_BUS_TIME_TO_WAIT_BEFORE_TRIGGERING_CIRCUIT_BREAKER}
      ExitOnCriticalError: ${EXIT_ON_CRITICAL_ERROR}
      ConnectionStrings__ams: ${AMS_DB}
      CultureCode: ${CULTURE_CODE}
      Serilog__LogstashUrl: http://${AMS_PROJECT_EXTERNAL_DNS_NAME_OR_IP}:8080
      Serilog__MinimumLevel: ${MIN_LOG_LEVEL}

  projectmanagement-readmodelgenerator:
    image: amssolution/projectmanagement.readmodelgenerator:linux-v3.0.1
    restart: always
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://0.0.0.0:80
      ServiceBusTimeToWaitBeforeTriggeringCircuitBreaker: ${SERVICE_BUS_TIME_TO_WAIT_BEFORE_TRIGGERING_CIRCUIT_BREAKER}
      ExitOnCriticalError: ${EXIT_ON_CRITICAL_ERROR}
      ConnectionStrings__ams: ${AMS_DB}
      ConnectionStrings__EventStore: ${EVENTSTORE_DB}
      Serilog__LogstashUrl: http://${AMS_PROJECT_EXTERNAL_DNS_NAME_OR_IP}:8080
      Serilog__MinimumLevel: ${MIN_LOG_LEVEL}

  projectmanagement-erpdata:
    image: amssolution/projectmanagement.erpdata:linux-v3.0.1
    restart: always
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://0.0.0.0:80
      ServiceBusTimeToWaitBeforeTriggeringCircuitBreaker: ${SERVICE_BUS_TIME_TO_WAIT_BEFORE_TRIGGERING_CIRCUIT_BREAKER}
      ExitOnCriticalError: ${EXIT_ON_CRITICAL_ERROR}
      ConnectionStrings__ams: ${AMS_DB}
      ConnectionStrings__EventStore: ${EVENTSTORE_DB}
      Serilog__LogstashUrl: http://${AMS_PROJECT_EXTERNAL_DNS_NAME_OR_IP}:8080
      Serilog__MinimumLevel: ${MIN_LOG_LEVEL}

  # ===========================================
  # PLANNING - REPORTING
  # ===========================================
  planning-reporting-api:
    image: amssolution/scheduling.reporting.api:linux-v3.0.1
    restart: always
    ports:
      - "7608:80"
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://0.0.0.0:80
      ConnectionStrings__ams: ${AMS_DB}
      Serilog__LogstashUrl: http://${AMS_PROJECT_EXTERNAL_DNS_NAME_OR_IP}:8080

  planning-reporting-clienthub:
    image: amssolution/scheduling.reporting.clienthub:linux-v3.0.1
    restart: always
    ports:
      - "7900:80"
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://0.0.0.0:80
      ConnectionStrings__ams: ${AMS_DB}
      ServiceBusTimeToWaitBeforeTriggeringCircuitBreaker: ${SERVICE_BUS_TIME_TO_WAIT_BEFORE_TRIGGERING_CIRCUIT_BREAKER}
      ExitOnCriticalError: ${EXIT_ON_CRITICAL_ERROR}
      Serilog__LogstashUrl: http://${AMS_PROJECT_EXTERNAL_DNS_NAME_OR_IP}:8080

  # ===========================================
  # PLANNING - TRACKING (ACCOUNTING)
  # ===========================================
  accounting-api:
    image: amssolution/accounting.api:linux-v3.0.1
    restart: always
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://0.0.0.0:80
      ConnectionStrings__ams: ${AMS_DB}
      ConnectionStrings__Cache: ${REDIS_DB}
      ServiceBusTimeToWaitBeforeTriggeringCircuitBreaker: ${SERVICE_BUS_TIME_TO_WAIT_BEFORE_TRIGGERING_CIRCUIT_BREAKER}
      ExitOnCriticalError: ${EXIT_ON_CRITICAL_ERROR}
      Serilog__LogstashUrl: http://${AMS_PROJECT_EXTERNAL_DNS_NAME_OR_IP}:8080
      Serilog__MinimumLevel: ${MIN_LOG_LEVEL}

  accounting-capacitydispatcher:
    image: amssolution/accounting.resourcecapacitydispatcher:linux-v3.0.1
    restart: always
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://0.0.0.0:80
      ConnectionStrings__Cache: ${REDIS_DB}
      ConnectionStrings__ams: ${AMS_DB}
      ServiceBusTimeToWaitBeforeTriggeringCircuitBreaker: ${SERVICE_BUS_TIME_TO_WAIT_BEFORE_TRIGGERING_CIRCUIT_BREAKER}
      ExitOnCriticalError: ${EXIT_ON_CRITICAL_ERROR}
      Serilog__LogstashUrl: http://${AMS_PROJECT_EXTERNAL_DNS_NAME_OR_IP}:8080
      Serilog__MinimumLevel: ${MIN_LOG_LEVEL}

  accounting-integration:
    image: amssolution/accounting.integration:linux-v3.0.1
    restart: always
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://0.0.0.0:80
      ConnectionStrings__ams: ${AMS_DB}
      ServiceBusTimeToWaitBeforeTriggeringCircuitBreaker: ${SERVICE_BUS_TIME_TO_WAIT_BEFORE_TRIGGERING_CIRCUIT_BREAKER}
      ExitOnCriticalError: ${EXIT_ON_CRITICAL_ERROR}
      Serilog__LogstashUrl: http://${AMS_PROJECT_EXTERNAL_DNS_NAME_OR_IP}:8080
      Serilog__MinimumLevel: ${MIN_LOG_LEVEL}

  capacityplanning-api:
    image: amssolution/capacityplanning.api:linux-v3.0.1
    restart: always
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_HTTP_PORTS: "80"
      ConnectionStrings__ams: ${AMS_DB}
      ServiceBusTimeToWaitBeforeTriggeringCircuitBreaker: ${SERVICE_BUS_TIME_TO_WAIT_BEFORE_TRIGGERING_CIRCUIT_BREAKER}
      ExitOnCriticalError: ${EXIT_ON_CRITICAL_ERROR}
      Serilog__LogstashUrl: http://${AMS_PROJECT_EXTERNAL_DNS_NAME_OR_IP}:8080
      Serilog__MinimumLevel: ${MIN_LOG_LEVEL}

  capacityplanning-readmodelgenerator:
    image: amssolution/capacityplanning.readmodelgenerator:linux-v3.0.1
    restart: always
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_HTTP_PORTS: "80"
      ConnectionStrings__ams: ${AMS_DB}
      ServiceBusTimeToWaitBeforeTriggeringCircuitBreaker: ${SERVICE_BUS_TIME_TO_WAIT_BEFORE_TRIGGERING_CIRCUIT_BREAKER}
      ExitOnCriticalError: ${EXIT_ON_CRITICAL_ERROR}
      Serilog__LogstashUrl: http://${AMS_PROJECT_EXTERNAL_DNS_NAME_OR_IP}:8080
      Serilog__MinimumLevel: ${MIN_LOG_LEVEL}
      Throttling__Rate: "00:00:01"
      Throttling__Limit: "2"
      Throttling__AdditionalResetTime: "00:00:00"

  # ===========================================
  # PLANNING - TYPE CURVE
  # ===========================================
  planning-typecurve-api:
    image: amssolution/planning-typecurve-api:linux-v3.0.1
    restart: always
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://0.0.0.0:80
      ConnectionStrings__ams: ${AMS_DB}
      Serilog__LogstashUrl: http://${AMS_PROJECT_EXTERNAL_DNS_NAME_OR_IP}:8080
      Serilog__MinimumLevel: ${MIN_LOG_LEVEL}

  # ===========================================
  # PRODUCTION PLANNING (BOM)
  # ===========================================
  bom-api:
    image: amssolution/productionplanning.bom.api:linux-v3.0.1
    restart: always
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://0.0.0.0:80
      ConnectionStrings__ams: ${AMS_DB}
      Serilog__LogstashUrl: http://${AMS_PROJECT_EXTERNAL_DNS_NAME_OR_IP}:8080
      Serilog__MinimumLevel: ${MIN_LOG_LEVEL}
      ExitOnCriticalError: ${EXIT_ON_CRITICAL_ERROR}
      ServiceBusTimeToWaitBeforeTriggeringCircuitBreaker: ${SERVICE_BUS_TIME_TO_WAIT_BEFORE_TRIGGERING_CIRCUIT_BREAKER}

  bom-readmodelgenerator:
    image: amssolution/productionplanning.readmodelgenerator:linux-v3.0.1
    restart: always
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://0.0.0.0:80
      ServiceBusTimeToWaitBeforeTriggeringCircuitBreaker: ${SERVICE_BUS_TIME_TO_WAIT_BEFORE_TRIGGERING_CIRCUIT_BREAKER}
      ConnectionStrings__ams: ${AMS_DB}
      ExitOnCriticalError: ${EXIT_ON_CRITICAL_ERROR}
      Serilog__LogstashUrl: http://${AMS_PROJECT_EXTERNAL_DNS_NAME_OR_IP}:8080
      Serilog__MinimumLevel: ${MIN_LOG_LEVEL}

  erpreadmodel-readmodelgenerator:
    image: amssolution/erpreadmodel.readmodelgenerator:linux-v3.0.1
    restart: always
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://0.0.0.0:80
      ConnectionStrings__ams: ${AMS_DB}
      Serilog__LogstashUrl: http://${AMS_PROJECT_EXTERNAL_DNS_NAME_OR_IP}:8080
      Serilog__MinimumLevel: ${MIN_LOG_LEVEL}

  # ===========================================
  # PROJECT EXPORTING
  # ===========================================
  projectexporting-readmodelgenerator:
    image: amssolution/projectexporting.readmodelgenerator:linux-v3.0.1
    restart: always
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://0.0.0.0:80
      ServiceBusTimeToWaitBeforeTriggeringCircuitBreaker: ${SERVICE_BUS_TIME_TO_WAIT_BEFORE_TRIGGERING_CIRCUIT_BREAKER}
      ConnectionStrings__ams: ${AMS_DB}
      ExitOnCriticalError: ${EXIT_ON_CRITICAL_ERROR}
      Serilog__LogstashUrl: http://${AMS_PROJECT_EXTERNAL_DNS_NAME_OR_IP}:8080
      Serilog__MinimumLevel: ${MIN_LOG_LEVEL}

  projectexporting-api:
    image: amssolution/projectexporting.api:linux-v3.0.1
    restart: always
    ports:
      - "7700:80"
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://0.0.0.0:80
      ConnectionStrings__ams: ${AMS_DB}
      Serilog__LogstashUrl: http://${AMS_PROJECT_EXTERNAL_DNS_NAME_OR_IP}:8080
      Serilog__MinimumLevel: ${MIN_LOG_LEVEL}

  projectexporting-client:
    image: amssolution/projectexporting.client:linux-v3.0.1
    restart: always

  # ===========================================
  # SALES ORDERS
  # ===========================================
  salesorders-api:
    image: amssolution/salesorders.api:linux-v3.0.1
    restart: always
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://0.0.0.0:80
      ConnectionStrings__ams: ${AMS_DB}
      ConnectionStrings__Cache: ${REDIS_DB}
      ServiceBusTimeToWaitBeforeTriggeringCircuitBreaker: ${SERVICE_BUS_TIME_TO_WAIT_BEFORE_TRIGGERING_CIRCUIT_BREAKER}
      ExitOnCriticalError: ${EXIT_ON_CRITICAL_ERROR}
      Serilog__LogstashUrl: http://${AMS_PROJECT_EXTERNAL_DNS_NAME_OR_IP}:8080
      Serilog__MinimumLevel: ${MIN_LOG_LEVEL}
    depends_on:
      - cachedata

  salesorders-integration:
    image: amssolution/salesorders.integration:linux-v3.0.1
    restart: always
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://0.0.0.0:80
      ConnectionStrings__ams: ${AMS_DB}
      ConnectionStrings__Cache: ${REDIS_DB}
      ServiceBusTimeToWaitBeforeTriggeringCircuitBreaker: ${SERVICE_BUS_TIME_TO_WAIT_BEFORE_TRIGGERING_CIRCUIT_BREAKER}
      ExitOnCriticalError: ${EXIT_ON_CRITICAL_ERROR}
      CultureCode: ${CULTURE_CODE}
      Serilog__LogstashUrl: http://${AMS_PROJECT_EXTERNAL_DNS_NAME_OR_IP}:8080
      Serilog__MinimumLevel: ${MIN_LOG_LEVEL}
    depends_on:
      - cachedata

  salesorders:
    image: amssolution/salesorders:linux-v3.0.1
    restart: always
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://0.0.0.0:80
      ConnectionStrings__ams: ${AMS_DB}
      ServiceBusTimeToWaitBeforeTriggeringCircuitBreaker: ${SERVICE_BUS_TIME_TO_WAIT_BEFORE_TRIGGERING_CIRCUIT_BREAKER}
      ExitOnCriticalError: ${EXIT_ON_CRITICAL_ERROR}
      Serilog__LogstashUrl: http://${AMS_PROJECT_EXTERNAL_DNS_NAME_OR_IP}:8080
      Serilog__MinimumLevel: ${MIN_LOG_LEVEL}

  projectplanning.salesorders-client:
    image: amssolution/projectplanning.salesorders.client:linux-v3.0.1
    restart: always

  # ===========================================
  # WAGE DATA
  # ===========================================
  wage-data-api:
    image: amssolution/wage.data.api:linux-v3.0.1-erp11
    restart: always
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://0.0.0.0:80
      ConnectionStrings__ams: ${AMS_DB}
      ServiceBusTimeToWaitBeforeTriggeringCircuitBreaker: ${SERVICE_BUS_TIME_TO_WAIT_BEFORE_TRIGGERING_CIRCUIT_BREAKER}
      ExitOnCriticalError: ${EXIT_ON_CRITICAL_ERROR}
      Serilog__LogstashUrl: http://${AMS_PROJECT_EXTERNAL_DNS_NAME_OR_IP}:8080
      Serilog__MinimumLevel: ${MIN_LOG_LEVEL}

  # ===========================================
  # DISCUSSIONS
  # ===========================================
  discussions-api:
    image: amssolution/discussions.api:linux-v3.0.1
    restart: always
    ports:
      - "7710:80"
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://0.0.0.0:80
      ConnectionStrings__ams: ${AMS_DB}
      ConnectionStrings__EventStore: ${GRPC_EVENTSTORE_DB}
      Serilog__LogstashUrl: http://${AMS_PROJECT_EXTERNAL_DNS_NAME_OR_IP}:8080
      Serilog__MinimumLevel: ${MIN_LOG_LEVEL}

  discussion-client:
    image: amssolution/discussion.client:linux-v3.0.1
    restart: always

  # ===========================================
  # MEMO
  # ===========================================
  memo-api:
    image: amssolution/memo.api:linux-v3.0.1
    restart: always
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://0.0.0.0:80
      ConnectionStrings__ams: ${AMS_DB}
      Serilog__LogstashUrl: http://${AMS_PROJECT_EXTERNAL_DNS_NAME_OR_IP}:8080
      Serilog__MinimumLevel: ${MIN_LOG_LEVEL}

  memo-client:
    image: amssolution/memo.client:linux-v3.0.1
    restart: always

  # ===========================================
  # BOM LINK
  # ===========================================
  bom-link-client:
    image: amssolution/bom.link.client:linux-v3.0.1
    restart: always

volumes:
  healthdata: {}
